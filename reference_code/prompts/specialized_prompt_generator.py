"""
SpecializedPromptGenerator - Toolå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå™¨
å„ãƒ„ãƒ¼ãƒ«å°‚ç”¨ã®ç‰¹åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€æœ€é©åŒ–ã•ã‚ŒãŸLLMå¿œç­”ã‚’å®Ÿç¾
"""

import logging
from typing import Dict, Any, Optional, List
from dataclasses import dataclass

from ..state.agent_state import AgentState, Plan, Step, Task


@dataclass
class SpecializedPromptTemplate:
    """Toolå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
    base_context: str           # Toolå›ºæœ‰ã®åŸºæœ¬å½¹å‰²å®šç¾©
    domain_knowledge: str       # Toolå°‚é–€çŸ¥è­˜
    operational_guidelines: str # æ“ä½œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
    output_format: str         # å‡ºåŠ›å½¢å¼ä»•æ§˜
    constraints: str           # åˆ¶ç´„ãƒ»åˆ¶é™äº‹é …
    error_handling: str        # ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ³•
    examples: List[str]        # å®Ÿç”¨ä¾‹


class SpecializedPromptGenerator:
    """Toolå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå™¨"""
    
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self._templates = self._initialize_templates()
    
    def _initialize_templates(self) -> Dict[str, SpecializedPromptTemplate]:
        """Toolå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åˆæœŸåŒ–"""
        return {
            "plan_tool": self._create_plan_tool_template(),
            "task_tool": self._create_task_tool_template(),
            "file_ops": self._create_file_ops_template(),
            "code_runner": self._create_code_runner_template(),
            "response_echo": self._create_response_echo_template()
        }
    
    # =================================
    # PlanToolå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    # =================================
    def _create_plan_tool_template(self) -> SpecializedPromptTemplate:
        """PlanToolå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
        return SpecializedPromptTemplate(
            base_context="""ã‚ãªãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨ˆç”»ç«‹æ¡ˆå°‚é–€å®¶ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–‹ç™ºç›®æ¨™ã‚’å®Ÿè¡Œå¯èƒ½ãªæ®µéšçš„è¨ˆç”»ï¼ˆPlanâ†’Stepï¼‰ã«åˆ†è§£ã™ã‚‹ã“ã¨ãŒå½¹å‰²ã§ã™ã€‚""",
            
            domain_knowledge="""### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºè¨ˆç”»ã®å°‚é–€çŸ¥è­˜

**é–‹ç™ºæ‰‹æ³•:**
- è¦ä»¶åˆ†æã‹ã‚‰å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆã¾ã§ã®æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸå®Ÿè£…é †åºã®æ±ºå®š
- ãƒªã‚¹ã‚¯è©•ä¾¡ã¨æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã®æ¤œè¨¼
- ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®è€ƒæ…®

**è¨ˆç”»å“è³ªã®åˆ¤æ–­åŸºæº–:**
- å…·ä½“æ€§: å„ã‚¹ãƒ†ãƒƒãƒ—ã§ä½•ã‚’å®Ÿè£…ã™ã‚‹ã‹ãŒæ˜ç¢º
- æ¸¬å®šå¯èƒ½æ€§: å®Œäº†åˆ¤å®šãŒå®¢è¦³çš„ã«å¯èƒ½
- å®Ÿç¾å¯èƒ½æ€§: æŠ€è¡“çš„åˆ¶ç´„ã¨æœŸé–“ã‚’è€ƒæ…®
- æ®µéšçš„ä¾¡å€¤æä¾›: æ—©æœŸã«å‹•ä½œã™ã‚‹ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’ä½œæˆ""",
            
            operational_guidelines="""### Planç”Ÿæˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**ã‚¹ãƒ†ãƒƒãƒ—æ•°ã®æ±ºå®š:**
- ã‚·ãƒ³ãƒ—ãƒ«ãªç›®æ¨™: 3-4ã‚¹ãƒ†ãƒƒãƒ—
- ä¸­ç¨‹åº¦ã®è¤‡é›‘ã•: 4-6ã‚¹ãƒ†ãƒƒãƒ—  
- è¤‡é›‘ãªç›®æ¨™: 5-7ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆãã‚Œä»¥ä¸Šã¯åˆ†å‰²ã‚’æ¤œè¨ï¼‰

**ä¾å­˜é–¢ä¿‚ã®è¨­è¨ˆ:**
- ç·šå½¢ä¾å­˜ã‚’åŸºæœ¬ã¨ã™ã‚‹
- ä¸¦è¡Œå®Ÿè¡Œå¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã¯ä¾å­˜é–¢ä¿‚ã‚’è¨­ã‘ãªã„
- å¾ªç’°ä¾å­˜ã¯çµ¶å¯¾ã«é¿ã‘ã‚‹
- ä¾å­˜ã®æ·±ã•ã¯æœ€å¤§3ãƒ¬ãƒ™ãƒ«ã¾ã§

**å®Ÿè¡Œå¯èƒ½æ€§ã®ç¢ºä¿:**
- å„ã‚¹ãƒ†ãƒƒãƒ—ã¯1-3æ—¥ç¨‹åº¦ã§å®Œäº†å¯èƒ½
- å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ãƒ»å‰ææ¡ä»¶ã‚’æ˜ç¢ºåŒ–
- å¤±æ•—æ™‚ã®ä»£æ›¿æ¡ˆã‚’è€ƒæ…®""",
            
            output_format="""### å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰

```json
{
  "plan": {
    "name": "ç›®æ¨™ã‚’è¡¨ã™ç°¡æ½”ãªè¨ˆç”»å",
    "goal": "è©³ç´°ãªç›®æ¨™èª¬æ˜",
    "steps": [
      {
        "name": "ã‚¹ãƒ†ãƒƒãƒ—åï¼ˆå‹•è©ã§é–‹å§‹ï¼‰",
        "description": "å…·ä½“çš„ãªå®Ÿè¡Œå†…å®¹ã¨æœŸå¾…ã•ã‚Œã‚‹æˆæœ",
        "depends_on": ["å‰æã¨ãªã‚‹step_idã®é…åˆ—"],
        "estimated_duration": "æƒ³å®šå®Ÿè¡Œæ™‚é–“",
        "success_criteria": "å®Œäº†åˆ¤å®šåŸºæº–"
      }
    ]
  }
}
```""",
            
            constraints="""### åˆ¶ç´„äº‹é …

**å¿…é ˆè¦ä»¶:**
- step_idã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€depends_onã«ã¯ä»–ã‚¹ãƒ†ãƒƒãƒ—ã®nameã‚’å‚ç…§
- å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯æœ€çµ‚çš„ã«goalé”æˆã«å¯„ä¸ã™ã‚‹ã“ã¨
- æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã‚’æ…é‡ã«è©•ä¾¡ã™ã‚‹ã“ã¨

**ç¦æ­¢äº‹é …:**
- æ›–æ˜§ãªè¡¨ç¾ï¼ˆã€Œé©åˆ‡ã«ã€ã€Œå¿…è¦ã«å¿œã˜ã¦ã€ç­‰ï¼‰ã®ä½¿ç”¨
- å®Ÿè¡Œè€…ãŒä¸æ˜ãªä½œæ¥­ã®å®šç¾©
- æœŸé–“ãŒäºˆæ¸¬ä¸å¯èƒ½ãªã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ³ãƒ‰ãªã‚¿ã‚¹ã‚¯""",
            
            error_handling="""### ã‚¨ãƒ©ãƒ¼å¯¾å‡¦

**ä¸æ˜ç¢ºãªç›®æ¨™ã®å ´åˆ:**
- å…·ä½“åŒ–ã®ãŸã‚ã®è³ªå•ã‚’reasoningã«å«ã‚ã‚‹
- æƒ³å®šã•ã‚Œã‚‹è§£é‡ˆã‚’è¤‡æ•°æç¤º
- æœ€ã‚‚ç¢ºå®Ÿæ€§ã®é«˜ã„è§£é‡ˆã§è¨ˆç”»ã‚’ææ¡ˆ

**è¤‡é›‘ã™ãã‚‹ç›®æ¨™ã®å ´åˆ:**  
- æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã«ç„¦ç‚¹ã‚’å½“ã¦ãŸè¨ˆç”»ã‚’ææ¡ˆ
- å¾Œç¶šãƒ•ã‚§ãƒ¼ã‚ºã¯åˆ¥é€”è¨ˆç”»ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨""",
            
            examples=[
                """ä¾‹1: ã€ŒWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹ã€
â†’ ã€Œã‚¿ã‚¹ã‚¯ç®¡ç†Webã‚¢ãƒ—ãƒªé–‹ç™ºè¨ˆç”»ã€
  1. è¦ä»¶å®šç¾©ãƒ»æŠ€è¡“é¸å®šï¼ˆæ©Ÿèƒ½ä»•æ§˜ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯é¸æŠï¼‰
  2. é–‹ç™ºç’°å¢ƒæ§‹ç¯‰ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ã€ä¾å­˜é–¢ä¿‚è¨­å®šï¼‰
  3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»å®Ÿè£…ï¼ˆã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  4. APIå®Ÿè£…ï¼ˆCRUDæ“ä½œã€èªè¨¼æ©Ÿèƒ½ï¼‰
  5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆUI/UXã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰
  6. ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå˜ä½“ãƒ»çµåˆãƒ†ã‚¹ãƒˆã€æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰ï¼‰""",
                
                """ä¾‹2: ã€ŒCLI ãƒ„ãƒ¼ãƒ«ã‚’ä½œã‚‹ã€  
â†’ ã€Œãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†CLIãƒ„ãƒ¼ãƒ«é–‹ç™ºè¨ˆç”»ã€
  1. è¦ä»¶åˆ†æãƒ»è¨­è¨ˆï¼ˆã‚³ãƒãƒ³ãƒ‰ä»•æ§˜ã€å…¥å‡ºåŠ›å½¢å¼ï¼‰
  2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆè¨€èªãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®šï¼‰
  3. ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
  4. CLI ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ï¼ˆå¼•æ•°è§£æã€ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºï¼‰
  5. ãƒ†ã‚¹ãƒˆãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆå˜ä½“ãƒ†ã‚¹ãƒˆã€å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼‰"""
            ]
        )
    
    # =================================
    # TaskToolå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    # =================================  
    def _create_task_tool_template(self) -> SpecializedPromptTemplate:
        """TaskToolå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
        return SpecializedPromptTemplate(
            base_context="""ã‚ãªãŸã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚¿ã‚¹ã‚¯ã®åˆ†è§£å°‚é–€å®¶ã§ã™ã€‚
æŠ½è±¡çš„ãªé–‹ç™ºã‚¹ãƒ†ãƒƒãƒ—ã‚’å…·ä½“çš„ãªå®Ÿè¡Œå¯èƒ½ã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã™ã‚‹ã“ã¨ãŒå½¹å‰²ã§ã™ã€‚""",
            
            domain_knowledge="""### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚¿ã‚¹ã‚¯åˆ†è§£ã®å°‚é–€çŸ¥è­˜

**åˆ†è§£ã®åŸå‰‡:**
- å˜ä¸€è²¬ä»»: 1ã¤ã®ã‚¿ã‚¹ã‚¯ã¯1ã¤ã®æ˜ç¢ºãªæˆæœç‰©ã‚’æŒã¤
- ç‹¬ç«‹å®Ÿè¡Œæ€§: ä»–ã®ã‚¿ã‚¹ã‚¯ã«éåº¦ã«ä¾å­˜ã—ãªã„
- ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§: å®Œäº†åˆ¤å®šãŒå®¢è¦³çš„ã«å¯èƒ½
- å®Ÿç¾å¯èƒ½ãªæ™‚é–“æ : 30åˆ†-2æ™‚é–“ã§å®Œäº†å¯èƒ½ãªç²’åº¦

**åˆ©ç”¨å¯èƒ½ãƒ„ãƒ¼ãƒ«:**
- file_ops.write: ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»ç·¨é›†ï¼ˆè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
- file_ops.read: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆæ–‡å­—ã‚³ãƒ¼ãƒ‰è‡ªå‹•æ¤œå‡ºï¼‰
- code_runner.run: ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒï¼‰
- test_runner.run: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼‰

**å®Ÿè¡Œé †åºã®è¨­è¨ˆ:**
- ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸé †åºä»˜ã‘
- æ—©æœŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ãŸã‚ã®æ¤œè¨¼ã‚¿ã‚¹ã‚¯é…ç½®
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ""",
            
            operational_guidelines="""### é–‹ç™ºã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**ã‚¿ã‚¹ã‚¯æ•°ã®æ±ºå®š:**
- ç°¡å˜ãªã‚¹ãƒ†ãƒƒãƒ—: 2-3ã‚¿ã‚¹ã‚¯
- ä¸­ç¨‹åº¦ã®ã‚¹ãƒ†ãƒƒãƒ—: 3-4ã‚¿ã‚¹ã‚¯
- è¤‡é›‘ãªã‚¹ãƒ†ãƒƒãƒ—: 4-5ã‚¿ã‚¹ã‚¯ï¼ˆãã‚Œä»¥ä¸Šã¯åˆ†å‰²ã‚’æ¤œè¨ï¼‰

**é–‹ç™ºã‚¿ã‚¹ã‚¯ã®é †åº:**
1. ç’°å¢ƒãƒ»ä¾å­˜é–¢ä¿‚ç¢ºèªï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
2. ã‚³ã‚¢å®Ÿè£…ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè£…ï¼‰
3. ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ï¼ˆå˜ä½“ãƒ†ã‚¹ãƒˆã€å‹•ä½œç¢ºèªï¼‰
4. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒ»æ•´ç†ï¼ˆã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Šã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼‰

**å“è³ªä¿è¨¼:**
- å„ã‚¿ã‚¹ã‚¯ã«æ˜ç¢ºãªæˆåŠŸæ¡ä»¶ã‚’è¨­å®š
- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­ç½®
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥ã‚’è€ƒæ…®""",
            
            output_format="""### å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰

```json
{
  "task_list": [
    {
      "operation": "tool_name.method_name",
      "args": {
        "key1": "value1",
        "key2": "value2"
      },
      "reasoning": "ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ç†ç”±ã¨æœŸå¾…ã•ã‚Œã‚‹çµæœ",
      "error_fallback": "å¤±æ•—æ™‚ã®ä»£æ›¿ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
    }
  ]
}
```""",
            
            constraints="""### åˆ¶ç´„äº‹é …

**operationå½¢å¼:**
- å¿…ãš "tool.method" å½¢å¼ã‚’ä½¿ç”¨
- å­˜åœ¨ã—ãªã„ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä½¿ç”¨ç¦æ­¢
- æœªæ¥ã«å®Ÿè£…äºˆå®šã®ãƒ„ãƒ¼ãƒ«ã¸ã®ä¾å­˜ã¯é¿ã‘ã‚‹

**argsæŒ‡å®š:**
- å„ãƒ„ãƒ¼ãƒ«ã®è¦æ±‚ã™ã‚‹å¼•æ•°å½¢å¼ã«å³å¯†ã«å¾“ã†
- å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ï¼ˆæ–‡å­—åˆ—ã€æ•°å€¤ã€é…åˆ—ã®é©åˆ‡ãªä½¿ç”¨ï¼‰
- å¿…é ˆå¼•æ•°ã®æ¼ã‚ŒãŒãªã„ã“ã¨ã‚’ç¢ºèª

**å®Ÿè¡Œæ™‚é–“åˆ¶é™:**
- å€‹åˆ¥ã‚¿ã‚¹ã‚¯ã¯æœ€å¤§2æ™‚é–“ä»¥å†…
- å…¨ä½“ã®TaskListã¯1æ—¥ä»¥å†…ã«å®Œäº†å¯èƒ½""",
            
            error_handling="""### ã‚¨ãƒ©ãƒ¼å¯¾å‡¦

**ãƒ„ãƒ¼ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼:**
- é©åˆ‡ãªãƒ„ãƒ¼ãƒ«ãŒä¸æ˜ãªå ´åˆã¯æœ€ã‚‚å®‰å…¨ãªé¸æŠè‚¢ã‚’é¸ã¶
- è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã§å®Ÿç¾å¯èƒ½ãªå ´åˆã¯ç°¡å˜ãªæ–¹ã‚’å„ªå…ˆ

**å¼•æ•°ã‚¨ãƒ©ãƒ¼:**
- ä¸æ˜ãªå¼•æ•°ã¯åˆç†çš„ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ¨å®š
- æ¨å®šãŒå›°é›£ãªå ´åˆã¯reasoningã§æ˜ç¢ºåŒ–ã‚’æ±‚ã‚ã‚‹""",
            
            examples=[
                """ä¾‹1: Stepã€Œãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã€
â†’ TaskList:
  1. file_ops.read â†’ package.jsonã®ç¢ºèª
  2. file_ops.write â†’ HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
  3. file_ops.write â†’ CSSã‚¹ã‚¿ã‚¤ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
  4. code_runner.run â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§ã®å‹•ä½œç¢ºèª""",
                
                """ä¾‹2: Stepã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã€
â†’ TaskList:
  1. file_ops.write â†’ ERãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã®ä½œæˆ
  2. file_ops.write â†’ SQLã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ  
  3. code_runner.run â†’ ã‚¹ã‚­ãƒ¼ãƒé©ç”¨ãƒ†ã‚¹ãƒˆ
  4. test_runner.run â†’ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ"""
            ]
        )
    
    # =================================
    # FileOpså°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    # =================================
    def _create_file_ops_template(self) -> SpecializedPromptTemplate:
        """FileOpså°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
        return SpecializedPromptTemplate(
            base_context="""ã‚ãªãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã®å®‰å…¨æ€§å°‚é–€å®¶ã§ã™ã€‚
å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã«ãŠã„ã¦å®‰å…¨æ€§ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ãŒå½¹å‰²ã§ã™ã€‚""",
            
            domain_knowledge="""### ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã®å°‚é–€çŸ¥è­˜

**å®‰å…¨æ€§ã®åŸºæœ¬åŸå‰‡:**
- ãƒ‡ãƒ¼ã‚¿æå¤±é˜²æ­¢: é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®æ“ä½œå‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡: æ¨©é™ã¨ãƒ‘ã‚¹ã®é©åˆ‡æ€§ç¢ºèª
- åŸå­æ€§: æ“ä½œã®å®Œå…¨æ€§ä¿è¨¼ï¼ˆéƒ¨åˆ†çš„å¤±æ•—ã®é˜²æ­¢ï¼‰
- å¯é€†æ€§: æ“ä½œã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½æ€§ç¢ºä¿

**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç†è§£:**
- ãƒ‘ã‚¹æ­£è¦åŒ–: ç›¸å¯¾ãƒ‘ã‚¹ãƒ»çµ¶å¯¾ãƒ‘ã‚¹ã®é©åˆ‡ãªå‡¦ç†
- æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8ã‚’åŸºæœ¬ã¨ã™ã‚‹å¤šè¨€èªå¯¾å¿œ
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯: åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€æ¨©é™ã€å±æ€§ã®ä¿æŒ

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®:**
- ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒå¯¾ç­–ï¼ˆ../ã®æ¤œå‡ºãƒ»æ‹’å¦ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿è­·ï¼ˆOSé‡è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼‰
- æ©Ÿå¯†æƒ…å ±æ¼æ´©é˜²æ­¢ï¼ˆãƒ­ã‚°ãƒ»ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®æ©Ÿå¯†æƒ…å ±éœ²å‡ºé˜²æ­¢ï¼‰""",
            
            operational_guidelines="""### æ“ä½œåˆ¥ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**writeæ“ä½œ:**
1. æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
2. å†…å®¹ã®äº‹å‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…ˆé ­ãƒ»æœ«å°¾ã®ã¿ï¼‰
3. æ›¸ãè¾¼ã¿å®Ÿè¡Œãƒ»å®Œå…¨æ€§ç¢ºèª
4. å¤±æ•—æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

**readæ“ä½œ:**
1. ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒ»ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª
2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆå¤§å®¹é‡è­¦å‘Šï¼‰
3. æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¤œå‡º
4. æ®µéšçš„èª­ã¿è¾¼ã¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**deleteæ“ä½œ:**
1. ãƒ•ã‚¡ã‚¤ãƒ«é‡è¦åº¦è©•ä¾¡
2. ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ï¼ˆä»–ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®å‚ç…§ï¼‰
3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼ˆè«–ç†å‰Šé™¤æ¨å¥¨ï¼‰
4. å‰Šé™¤å®Ÿè¡Œãƒ»ç¢ºèª

**createæ“ä½œ:**
1. è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèªãƒ»ä½œæˆ
2. åŒåãƒ•ã‚¡ã‚¤ãƒ«é‡è¤‡ãƒã‚§ãƒƒã‚¯
3. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»åˆæœŸå†…å®¹è¨­å®š
4. æ¨©é™ãƒ»å±æ€§è¨­å®š""",
            
            output_format="""### æ“ä½œå®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹

**äº‹å‰ãƒã‚§ãƒƒã‚¯çµæœ:**
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹æ­£å½“æ€§: OK/NG + ç†ç”±
- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™: OK/NG + å¿…è¦æ¨©é™
- å®‰å…¨æ€§è©•ä¾¡: Safe/Caution/Danger + è©•ä¾¡ç†ç”±

**å®Ÿè¡Œè¨ˆç”»:**
- å®Ÿè¡Œæ‰‹é †ã®è©³ç´°ã‚¹ãƒ†ãƒƒãƒ—
- ãƒªã‚¹ã‚¯è¦ç´ ã¨ãã®å¯¾ç­–
- å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

**å®Ÿè¡Œçµæœ:**
- æˆåŠŸ/å¤±æ•—ã®æ˜ç¢ºãªåˆ¤å®š
- å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼
- æ¬¡ã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³""",
            
            constraints="""### åˆ¶ç´„äº‹é …

**ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³:**
- ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ/etc, /sys, C:\\Windowsç­‰ï¼‰ã¸ã®æ›¸ãè¾¼ã¿
- å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.exe, .shç­‰ï¼‰ã®ç„¡æ–­ä½œæˆ
- æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿

**åˆ¶é™äº‹é …:**
- å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 100MBä»¥ä¸‹æ¨å¥¨
- åŒæ™‚æ“ä½œãƒ•ã‚¡ã‚¤ãƒ«æ•°: 10ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸‹
- ãƒ‘ã‚¹é•·: 260æ–‡å­—ä»¥ä¸‹ï¼ˆWindowsäº’æ›æ€§ï¼‰

**å¿…é ˆç¢ºèª:**
- æ“ä½œå‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªï¼ˆé‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼‰
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆå®Œäº†ç¢ºèª
- æ“ä½œå®Œäº†å¾Œã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯""",
            
            error_handling="""### ã‚¨ãƒ©ãƒ¼å¯¾å‡¦

**æ¨©é™ã‚¨ãƒ©ãƒ¼:**
- å¿…è¦æ¨©é™ã®æ˜ç¢ºåŒ–ã¨å–å¾—æ–¹æ³•ã®æç¤º
- ä»£æ›¿ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã®ææ¡ˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±èª¬æ˜

**å®¹é‡ã‚¨ãƒ©ãƒ¼:**
- ä½¿ç”¨å¯èƒ½å®¹é‡ã®ç¢ºèªãƒ»å ±å‘Š
- ãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®ãƒ»åˆ†å‰²ã®ææ¡ˆ
- ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã®æ¨å¥¨

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:**
- ãƒ­ãƒƒã‚¯è¦å› ã®ç‰¹å®šãƒ»èª¬æ˜
- è§£é™¤æ–¹æ³•ã®æç¤º
- ä»£æ›¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã®å†è©¦è¡Œææ¡ˆ""",
            
            examples=[
                """ä¾‹1: é‡è¦ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†
â†’ 1. config.yml.bakupã‚’ä½œæˆ
â†’ 2. å¤‰æ›´å†…å®¹ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª
â†’ 3. æ®µéšçš„ç·¨é›†ãƒ»æ¤œè¨¼
â†’ 4. å•é¡Œç™ºç”Ÿæ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯""",
                
                """ä¾‹2: å¤§å®¹é‡ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
â†’ 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèªï¼ˆè­¦å‘Šè¡¨ç¤ºï¼‰
â†’ 2. å…ˆé ­1000è¡Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
â†’ 3. å…¨ä½“èª­ã¿è¾¼ã¿ã®ç¢ºèªå–å¾—
â†’ 4. ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªæ®µéšçš„èª­ã¿è¾¼ã¿"""
            ]
        )
    
    # =================================
    # CodeRunnerå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    # =================================
    def _create_code_runner_template(self) -> SpecializedPromptTemplate:
        """CodeRunnerå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
        return SpecializedPromptTemplate(
            base_context="""ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œç’°å¢ƒã®å®‰å…¨æ€§å°‚é–€å®¶ã§ã™ã€‚
ã‚ã‚‰ã‚†ã‚‹ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã«ãŠã„ã¦å®‰å…¨æ€§ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æœ€å„ªå…ˆã«ç¢ºä¿ã™ã‚‹ã“ã¨ãŒå½¹å‰²ã§ã™ã€‚""",
            
            domain_knowledge="""### ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã®å°‚é–€çŸ¥è­˜

**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡ŒåŸå‰‡:**
- ãƒ—ãƒ­ã‚»ã‚¹åˆ†é›¢: ãƒ›ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®å®Œå…¨åˆ†é›¢
- ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™: CPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ»å®Ÿè¡Œæ™‚é–“ã®å³æ ¼ãªåˆ¶é™
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶å¾¡: å¤–éƒ¨é€šä¿¡ã®åˆ¶é™ãƒ»ç›£è¦–
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¿è­·: è¨±å¯ã•ã‚ŒãŸé ˜åŸŸã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

**è¨€èªåˆ¥å®Ÿè¡Œç’°å¢ƒ:**
- Python: venvä»®æƒ³ç’°å¢ƒã€pipä¾å­˜é–¢ä¿‚ç®¡ç†
- JavaScript: Node.js LTSã€npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†
- Shell: bashåˆ¶é™ãƒ¢ãƒ¼ãƒ‰ã€å±é™ºã‚³ãƒãƒ³ãƒ‰æ¤œå‡º
- SQL: readonlyå®Ÿè¡Œã€DDLåˆ¶é™

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨å¯¾ç­–:**
- ã‚³ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢
- ç„¡é™ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ•ã‚©ãƒ¼ã‚¯ãƒœãƒ æ¤œå‡º
- ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ç›£è¦–
- æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ¤œå‡º""",
            
            operational_guidelines="""### å®Ÿè¡Œå‰å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯

**ã‚³ãƒ¼ãƒ‰é™çš„è§£æ:**
1. å±é™ºé–¢æ•°ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¤œå‡º
   - exec(), eval(), subprocessç­‰
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ“ä½œãƒ©ã‚¤ãƒ–ãƒ©ãƒª
2. å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã®è©•ä¾¡
3. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã®æ¨å®š

**å®Ÿè¡Œç’°å¢ƒæº–å‚™:**
1. ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
2. ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™è¨­å®š
3. ç›£è¦–ãƒ»ãƒ­ã‚°æ©Ÿèƒ½æœ‰åŠ¹åŒ–
4. ç·Šæ€¥åœæ­¢æ©Ÿèƒ½æº–å‚™

**å®Ÿè¡Œç›£è¦–:**
1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç›£è¦–
2. å®Ÿè¡Œæ™‚é–“åˆ¶é™ã®é©ç”¨
3. ç•°å¸¸å‹•ä½œã®æ¤œå‡ºãƒ»å¯¾å‡¦
4. ãƒ­ã‚°åé›†ãƒ»åˆ†æ""",
            
            output_format="""### å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ

**å®‰å…¨æ€§è©•ä¾¡:**
- ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: Safe/Low/Medium/High/Critical
- æ¤œå‡ºã•ã‚ŒãŸæ½œåœ¨çš„è„…å¨ã¨ãã®å¯¾ç­–
- å®Ÿè¡Œç’°å¢ƒã®éš”é›¢çŠ¶æ³

**å®Ÿè¡Œçµæœ:**
- æ¨™æº–å‡ºåŠ›ãƒ»æ¨™æº–ã‚¨ãƒ©ãƒ¼ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ï¼‰
- çµ‚äº†ã‚³ãƒ¼ãƒ‰ãƒ»å®Ÿè¡Œæ™‚é–“
- ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ï¼ˆCPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ»ãƒ‡ã‚£ã‚¹ã‚¯ï¼‰
- å®Ÿè¡Œä¸­ã®ç•°å¸¸äº‹è±¡ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ã‚¨ãƒ©ãƒ¼ç­‰ï¼‰

**æ¨å¥¨äº‹é …:**
- ã‚³ãƒ¼ãƒ‰ã®æ”¹å–„ææ¡ˆ
- ã‚ˆã‚Šå®‰å…¨ãªä»£æ›¿å®Ÿè£…
- è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–""",
            
            constraints="""### å®Ÿè¡Œåˆ¶é™

**çµ¶å¯¾ç¦æ­¢:**
- ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆrootæ¨©é™è¦æ±‚ç­‰ï¼‰
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ï¼ˆHTTP/FTPç­‰ï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹
- ä»–ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®å½±éŸ¿

**ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™:**
- å®Ÿè¡Œæ™‚é–“: 30ç§’ï¼ˆé€šå¸¸ï¼‰/ 5åˆ†ï¼ˆç‰¹åˆ¥è¨±å¯ï¼‰
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 128MBï¼ˆé€šå¸¸ï¼‰/ 512MBï¼ˆç‰¹åˆ¥è¨±å¯ï¼‰
- CPUä½¿ç”¨ç‡: 50%ï¼ˆæŒç¶šçš„ï¼‰
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡: 10MBä¸€æ™‚é ˜åŸŸ

**è¨€èªåˆ¥åˆ¶ç´„:**
- Python: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯äº‹å‰æ‰¿èªåˆ¶
- JavaScript: Node.jsæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã¿
- Shell: åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåˆ¶""",
            
            error_handling="""### ã‚¨ãƒ©ãƒ¼ãƒ»ç•°å¸¸å¯¾å‡¦

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:**
- å®Ÿè¡Œã‚’å¼·åˆ¶çµ‚äº†
- éƒ¨åˆ†å®Ÿè¡Œçµæœã®æä¾›
- ã‚ˆã‚ŠåŠ¹ç‡çš„ãªå®Ÿè£…ã®ææ¡ˆ

**ãƒ¡ãƒ¢ãƒªä¸è¶³:**
- ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ãƒ»ãƒªã‚½ãƒ¼ã‚¹å›å
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ææ¡ˆ
- ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®åˆ†å‰²å®Ÿè¡Œæ¨å¥¨

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•å:**
- å³åº§ã«å®Ÿè¡Œåœæ­¢
- é•åå†…å®¹ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
- å®‰å…¨ãªä»£æ›¿å®Ÿè£…ã®æä¾›""",
            
            examples=[
                """ä¾‹1: Pythonãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â†’ 1. importãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
â†’ 2. venvç’°å¢ƒã§ã®åˆ†é›¢å®Ÿè¡Œ
â†’ 3. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
â†’ 4. çµæœãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º""",
                
                """ä¾‹2: JavaScriptãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â†’ 1. Node.jsæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ç¢ºèª
â†’ 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç„¡åŠ¹åŒ–
â†’ 3. console.logå‡ºåŠ›ã®åˆ¶é™ãƒ»ç›£è¦–
â†’ 4. ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®é©åˆ‡æ€§ç¢ºèª"""
            ]
        )
    
    # =================================
    # Response.Echoå°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ  
    # =================================
    def _create_response_echo_template(self) -> SpecializedPromptTemplate:
        """Response.Echoå°‚ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ"""
        return SpecializedPromptTemplate(
            base_context="""ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å°‚é–€å®¶ã§ã™ã€‚
é©åˆ‡ã§åˆ†ã‹ã‚Šã‚„ã™ãã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒã™ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒå½¹å‰²ã§ã™ã€‚""",
            
            domain_knowledge="""### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŸå‰‡

**å¿œç­”è¨­è¨ˆã®åŸºæœ¬:**
- æ˜ç¢ºæ€§: æ›–æ˜§ã•ã‚’æ’é™¤ã—ãŸå…·ä½“çš„ãªè¡¨ç¾
- æœ‰ç”¨æ€§: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ˜ç¢ºåŒ–
- å…±æ„Ÿæ€§: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ³ãƒ»æ„Ÿæƒ…ã¸ã®é…æ…®
- å°‚é–€æ€§: æŠ€è¡“çš„æ­£ç¢ºæ€§ã¨åˆ†ã‹ã‚Šã‚„ã™ã•ã®ä¸¡ç«‹

**æƒ…å ±éšå±¤è¨­è¨ˆ:**
1. çµæœã‚µãƒãƒªãƒ¼ï¼ˆæˆåŠŸ/å¤±æ•—/è­¦å‘Šï¼‰
2. é‡è¦ãªè©³ç´°æƒ…å ±
3. è£œè¶³ãƒ»å‚è€ƒæƒ…å ±
4. æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**å¤šæ§˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼å±¤ã¸ã®å¯¾å¿œ:**
- æŠ€è¡“åˆå¿ƒè€…: å°‚é–€ç”¨èªã®è§£èª¬ã€æ®µéšçš„èª¬æ˜
- çµŒé¨“è€…: ç°¡æ½”ã§è¦ç‚¹ã‚’çµã£ãŸæƒ…å ±
- ç·Šæ€¥æ™‚: æœ€é‡è¦æƒ…å ±ã®å„ªå…ˆè¡¨ç¤º""",
            
            operational_guidelines="""### å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**æˆåŠŸå¿œç­”:**
- é”æˆã•ã‚ŒãŸå…·ä½“çš„æˆæœã®æ˜ç¤º
- é–¢é€£ã™ã‚‹å‰¯æ¬¡çš„åŠ¹æœãƒ»å¤‰æ›´ç‚¹
- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ææ¡ˆ
- æˆåŠŸã‚’æ´»ç”¨ã—ãŸç™ºå±•çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**è­¦å‘Šå¿œç­”:**
- ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®æ˜ç¢ºåŒ–ï¼ˆLow/Medium/Highï¼‰
- å…·ä½“çš„ãƒªã‚¹ã‚¯å†…å®¹ã¨ç™ºç”Ÿæ¡ä»¶
- å¯¾å‡¦æ³•ã®å…·ä½“çš„æ‰‹é †
- å®Ÿè¡Œã™ã‚‹ã‹ã®æ˜ç¢ºãªé¸æŠè‚¢æç¤º

**ã‚¨ãƒ©ãƒ¼å¿œç­”:**
- ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› åˆ†æ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿè¡Œå¯èƒ½ãªè§£æ±ºç­–
- ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ææ¡ˆ
- å¿…è¦ã«å¿œã˜ã¦å°‚é–€ã‚µãƒãƒ¼ãƒˆã¸ã®èª˜å°

**æƒ…å ±æä¾›å¿œç­”:**
- æƒ…å ±ã®æ§‹é€ åŒ–ãƒ»è¦–è¦šçš„æ•´ç†
- é‡è¦åº¦ã«å¿œã˜ãŸæƒ…å ±ã®éšå±¤åŒ–
- é–¢é€£æƒ…å ±ãƒ»å‚è€ƒè³‡æ–™ã®æç¤º
- æƒ…å ±ã‚’æ´»ç”¨ã—ãŸæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ""",
            
            output_format="""### å¿œç­”æ§‹é€ 

**åŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:**
```
[çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼] ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

è©³ç´°æƒ…å ±:
- ãƒã‚¤ãƒ³ãƒˆ1
- ãƒã‚¤ãƒ³ãƒˆ2

æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
1. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³1
2. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³2

è£œè¶³: è¿½åŠ ã®é‡è¦ãªæƒ…å ±
```

**çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼:**
- âœ… æˆåŠŸãƒ»å®Œäº†
- âš ï¸ è­¦å‘Šãƒ»æ³¨æ„
- âŒ ã‚¨ãƒ©ãƒ¼ãƒ»å¤±æ•—  
- â„¹ï¸ æƒ…å ±ãƒ»å‚è€ƒ
- ğŸ”„ é€²è¡Œä¸­ãƒ»å‡¦ç†ä¸­""",
            
            constraints="""### å¿œç­”åˆ¶ç´„

**æ–‡ç« å“è³ª:**
- 1å¿œç­”ã‚ãŸã‚Š200-500æ–‡å­—ã‚’ç›®å®‰
- å°‚é–€ç”¨èªã¯å¿…è¦ã«å¿œã˜ã¦èª¬æ˜ã‚’ä½µè¨˜
- èƒ½å‹•æ…‹ãƒ»å…·ä½“çš„è¡¨ç¾ã‚’å„ªå…ˆ
- æ›–æ˜§ãªè¡¨ç¾ï¼ˆã€Œé©åˆ‡ã«ã€ã€Œå¿…è¦ã«å¿œã˜ã¦ã€ç­‰ï¼‰ã®å›é¿

**æƒ…å ±ç²¾åº¦:**
- æ¨æ¸¬ãƒ»æ†¶æ¸¬ã®æ˜ç¢ºãªåŒºåˆ¥
- ä¸ç¢ºå®Ÿãªæƒ…å ±ã¯ç¢ºå®Ÿæ€§ãƒ¬ãƒ™ãƒ«ã‚’æ˜ç¤º
- æ™‚é–“çš„åˆ¶ç´„ã®ã‚ã‚‹æƒ…å ±ã¯æœŸé™ã‚’æ˜è¨˜
- å¤–éƒ¨ä¾å­˜ã®æƒ…å ±ã¯æƒ…å ±æºã‚’æ˜ç¤º

**ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£:**
- æŠ€è¡“ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸèª¬æ˜æ·±åº¦èª¿æ•´
- å®Ÿè¡Œå¯èƒ½ãªå…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æç¤º
- é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆã¯åˆ¤æ–­åŸºæº–ã‚’æä¾›""",
            
            error_handling="""### ç‰¹æ®ŠçŠ¶æ³å¯¾å‡¦

**æƒ…å ±ä¸è¶³æ™‚:**
- åˆ©ç”¨å¯èƒ½ãªæƒ…å ±ã§ã®æœ€è‰¯ã®å¿œç­”æä¾›
- ä¸è¶³æƒ…å ±ã®å…·ä½“çš„ãªç‰¹å®š
- æƒ…å ±å–å¾—æ–¹æ³•ã®æç¤º

**çŸ›ç›¾ãƒ»ä¸æ•´åˆæ¤œå‡ºæ™‚:**
- çŸ›ç›¾ç‚¹ã®æ˜ç¢ºåŒ–
- å¯èƒ½æ€§ã®é«˜ã„è§£é‡ˆã®æç¤º
- ç¢ºèªã™ã¹ãäº‹é …ã®æ˜ç¤º

**ç·Šæ€¥æ™‚å¯¾å¿œ:**
- æœ€é‡è¦æƒ…å ±ã®å„ªå…ˆè¡¨ç¤º
- å³åº§ã«å®Ÿè¡Œã™ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ˜ç¤º
- è©³ç´°æƒ…å ±ã¯å¾Œå›ã—ã«ã—ãŸç°¡æ½”ãªå¿œç­”""",
            
            examples=[
                """ä¾‹1: ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æˆåŠŸ
âœ… ãƒ•ã‚¡ã‚¤ãƒ« 'config.yaml' ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ

å¤‰æ›´å†…å®¹:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®šã‚’æ›´æ–°
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ 'config.yaml.bak' ã«ä¿å­˜

æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•ã—ã¦è¨­å®šã‚’åæ˜ 
2. è¨­å®šãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ""",
                
                """ä¾‹2: ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼
âŒ Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

ã‚¨ãƒ©ãƒ¼åŸå› : ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« 'pandas' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

è§£æ±ºæ–¹æ³•:
1. pip install pandas ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. ä»®æƒ³ç’°å¢ƒãŒæ­£ã—ãæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

ä»£æ›¿æ¡ˆ: æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã¿ã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ã«å¤‰æ›´"""
            ]
        )
    
    # =================================
    # å…¬é–‹ãƒ¡ã‚½ãƒƒãƒ‰  
    # =================================
    def generate_tool_specialized_context(
        self, 
        tool_name: str, 
        agent_state: AgentState, 
        operation_args: Optional[Dict[str, Any]] = None
    ) -> str:
        """Toolå°‚ç”¨ã®Specializedã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ"""
        try:
            if tool_name not in self._templates:
                self.logger.warning(f"æœªçŸ¥ã®ãƒ„ãƒ¼ãƒ«: {tool_name}, æ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨")
                return self._generate_generic_context(tool_name, agent_state, operation_args)
            
            template = self._templates[tool_name]
            
            # å‹•çš„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ§‹ç¯‰
            dynamic_context = self._build_dynamic_context(agent_state, operation_args)
            
            # å®Œå…¨ãªSpecializedãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
            specialized_context = f"""{template.base_context}

{template.domain_knowledge}

{template.operational_guidelines}

{template.output_format}

{template.constraints}

{template.error_handling}

### ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
{dynamic_context}

### å®Ÿè¡Œä¾‹
{self._format_examples(template.examples)}"""
            
            self.logger.info(f"{tool_name}ç”¨Specializedãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå®Œäº†")
            return specialized_context
            
        except Exception as e:
            self.logger.error(f"{tool_name}ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return self._generate_fallback_context(tool_name)
    
    def _build_dynamic_context(
        self, 
        agent_state: AgentState, 
        operation_args: Optional[Dict[str, Any]]
    ) -> str:
        """å‹•çš„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰ã€AgentStateã®çŸ­æœŸè¨˜æ†¶ã‚’æ´»ç”¨"""
        try:
            context_parts = []
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
            context_parts.append(f"ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: {agent_state.session_id}")
            
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ©ãƒ³æƒ…å ±
            if agent_state.plans:
                active_plan = self._get_active_plan(agent_state)
                if active_plan:
                    context_parts.append(f"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ©ãƒ³: {active_plan.name} ({active_plan.goal})")
                    context_parts.append(f"ã‚¹ãƒ†ãƒƒãƒ—æ•°: {len(active_plan.steps)} (å®Œäº†: {sum(1 for s in active_plan.steps if s.status == 'completed')}ä»¶)")
            
            # æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æƒ…å ±
            recent_files = agent_state.short_term_memory.get("recent_files", [])
            if recent_files:
                latest_file = recent_files[-1]
                context_parts.append(f"æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«: {latest_file.get('file_path', 'N/A')} (é•·ã•: {latest_file.get('content_length', 0)}æ–‡å­—)")
                # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ä¸€éƒ¨ã‚’å«ã‚ã‚‹
                file_summary = latest_file.get('content', '')
                if len(file_summary) > 300:
                    file_summary = file_summary[:300] + "..."
                context_parts.append(f"ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹æ¦‚è¦: {file_summary}")
            
            # ç¾åœ¨ã®ä½œæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            current_context = agent_state.short_term_memory.get("current_context", {})
            if current_context:
                if 'last_read_file' in current_context:
                    context_parts.append(f"ä½œæ¥­ä¸­ãƒ•ã‚¡ã‚¤ãƒ«: {current_context['last_read_file']}")
                if 'content_summary' in current_context:
                    summary = current_context['content_summary']
                    if len(summary) > 200:
                        summary = summary[:200] + "..."
                    context_parts.append(f"ä½œæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: {summary}")
            
            # ç›®æ¨™æƒ…å ±
            if agent_state.goal:
                context_parts.append(f"ç¾åœ¨ã®ç›®æ¨™: {agent_state.goal}")
            
            # æœ€æ–°ã®ä¼šè©±å±¥æ­´
            if agent_state.conversation_history:
                recent_count = min(3, len(agent_state.conversation_history))
                context_parts.append(f"æœ€è¿‘ã®ä¼šè©±: {recent_count}ä»¶")
                # æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚ã‚‹
                for msg in agent_state.conversation_history[-2:]:
                    if msg.role == "user":
                        user_msg = msg.content[:150] + "..." if len(msg.content) > 150 else msg.content
                        context_parts.append(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚: {user_msg}")
            
            # æ“ä½œå¼•æ•°
            if operation_args:
                formatted_args = self._format_operation_args(operation_args)
                context_parts.append(f"æ“ä½œå¼•æ•°: {formatted_args}")
            
            return "\n".join(context_parts)
            
        except Exception as e:
            self.logger.warning(f"å‹•çš„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ã‚¨ãƒ©ãƒ¼: {e}")
            return "ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
    
    def _get_active_plan(self, agent_state: AgentState) -> Optional[Plan]:
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ©ãƒ³ã‚’å–å¾—"""
        if not agent_state.active_plan_id:
            return None
        
        for plan in agent_state.plans:
            if plan.plan_id == agent_state.active_plan_id:
                return plan
        return None
    
    def _format_operation_args(self, args: Dict[str, Any]) -> str:
        """æ“ä½œå¼•æ•°ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
        try:
            formatted_items = []
            for key, value in args.items():
                if isinstance(value, str) and len(value) > 50:
                    value = value[:47] + "..."
                formatted_items.append(f"{key}={value}")
            return ", ".join(formatted_items)
        except Exception:
            return str(args)
    
    def _format_examples(self, examples: List[str]) -> str:
        """å®Ÿä¾‹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
        if not examples:
            return "å®Ÿä¾‹ãªã—"
        
        formatted_examples = []
        for i, example in enumerate(examples, 1):
            formatted_examples.append(f"**ä¾‹{i}:**\n{example}")
        
        return "\n\n".join(formatted_examples)
    
    def _generate_generic_context(
        self, 
        tool_name: str, 
        agent_state: AgentState, 
        operation_args: Optional[Dict[str, Any]]
    ) -> str:
        """æ±ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆï¼ˆæœªçŸ¥ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰"""
        return f"""### {tool_name}ç”¨æ±ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

ã‚ãªãŸã¯{tool_name}ãƒ„ãƒ¼ãƒ«ã®æ“ä½œã‚’æ”¯æ´ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
å®‰å…¨æ€§ã¨åŠ¹ç‡æ€§ã‚’æœ€å„ªå…ˆã«ã€ä»¥ä¸‹ã®åŸå‰‡ã«å¾“ã£ã¦æ“ä½œã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

åŸºæœ¬åŸå‰‡:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã‚’æ­£ç¢ºã«ç†è§£ã™ã‚‹
- å®‰å…¨æ€§ã‚’ç¢ºä¿ã—ãŸä¸Šã§æœ€é©ãªæ–¹æ³•ã‚’é¸æŠã™ã‚‹
- å®Ÿè¡Œçµæœã‚’æ˜ç¢ºã«å ±å‘Šã™ã‚‹
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯é©åˆ‡ã«å¯¾å‡¦ã™ã‚‹

ç¾åœ¨ã®çŠ¶æ³:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³: {agent_state.session_id}
- æ“ä½œå¼•æ•°: {operation_args if operation_args else 'ãªã—'}"""
    
    def _generate_fallback_context(self, tool_name: str) -> str:
        """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨æœ€å°é™ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ"""
        return f"""### {tool_name}ç”¨åŸºæœ¬ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

å®‰å…¨æ€§ã‚’æœ€å„ªå…ˆã«ã€æ…é‡ã«æ“ä½œã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
ä¸æ˜ãªç‚¹ãŒã‚ã‚‹å ´åˆã¯ç¢ºèªã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚"""
    
    def list_supported_tools(self) -> List[str]:
        """ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾—"""
        return list(self._templates.keys())
    
    def get_tool_template_info(self, tool_name: str) -> Dict[str, Any]:
        """ãƒ„ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—"""
        if tool_name not in self._templates:
            return {"error": f"ãƒ„ãƒ¼ãƒ« '{tool_name}' ã¯æœªã‚µãƒãƒ¼ãƒˆã§ã™"}
        
        template = self._templates[tool_name]
        return {
            "tool_name": tool_name,
            "base_context_length": len(template.base_context),
            "domain_knowledge_sections": len(template.domain_knowledge.split("###")),
            "examples_count": len(template.examples),
            "supported": True
        }