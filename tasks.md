# Duck Pacemaker 動的ループ制限システム実装タスク

## 実装計画

このタスクリストは、現在の固定ループ制限（3回/10回）を、D.U.C.K. Vitals Systemとタスク複雑度に基づくシンプルな動的制御システムに変更するための実装手順です。

## Phase 1: 基盤実装

### 1.1 シンプル制限計算器の実装

- [ ] `codecrafter/pacemaker/simple_loop_calculator.py` を作成
  - タスクプロファイル別ベース値の定義（5-18回の範囲）
  - バイタル係数計算メソッドの実装（mood, focus, stamina の正しい解釈）
  - 複雑度係数計算メソッドの実装
  - シンプルな計算式の実装: `ベース値 × バイタル係数 × 複雑度係数`
  - 制限範囲の適用（最小3回、最大20回）
  - _Requirements: 設計ドキュメントの計算式仕様_

### 1.2 コンテキスト複雑度分析器の実装

- [ ] `codecrafter/pacemaker/simple_context_analyzer.py` を作成
  - ファイル数による複雑度計算（8ファイルで最大）
  - 対話履歴長による複雑度計算（15ターンで最大）
  - エラー発生率による複雑度計算（33%で最大）
  - 総合複雑度スコア計算（0.0-1.0の範囲）
  - _Requirements: シンプルで確実な複雑度分析_

### 1.3 シンプルフォールバック機能の実装

- [ ] `codecrafter/pacemaker/simple_fallback.py` を作成
  - メイン計算の実行とエラーハンドリング
  - 設定ファイルからの最大値取得機能
  - 最終フォールバック値（15回）の設定
  - ログ出力機能（警告レベル）
  - _Requirements: 1段階のシンプルなフォールバック_

## Phase 2: メインシステム実装

### 2.1 シンプル動的Duck Pacemakerの実装

- [ ] `codecrafter/pacemaker/simple_dynamic_pacemaker.py` を作成
  - タスクプロファイル別ベース値辞書の定義
  - 動的制限計算メソッドの実装
  - 詳細な理由説明生成メソッドの実装
  - セッション開始処理の実装
  - フォールバック統合の実装
  - _Requirements: シンプルで確実な動的制限計算_

### 2.2 状況説明と選択肢提示システムの実装

- [ ] `codecrafter/pacemaker/user_consultation.py` を作成
  - 4つの介入パターンの定義（進捗停滞、自信不足、思考混乱、過度な試行）
  - 状況説明文の生成機能
  - 4択選択肢の提示機能
  - ユーザー選択の処理機能
  - Rich UIとの統合
  - _Requirements: 数値ではなく状況説明による透明性_

## Phase 3: 既存システム統合

### 3.1 AgentStateの拡張

- [ ] `codecrafter/state/agent_state.py` を修正
  - D.U.C.K. Vitals Systemの正しい解釈をコメントに追加
  - 動的制限関連フィールドの追加（必要に応じて）
  - バイタル更新メソッドの確認・調整
  - _Requirements: 既存のVitalsシステムとの整合性_

### 3.2 5ノードオーケストレーターとの統合

- [ ] `codecrafter/orchestration/five_node_orchestrator.py` を修正
  - SimpleDynamicPacemakerのインポートと初期化
  - セッション開始時の動的制限設定
  - 実行中のバイタル監視統合
  - 介入判定とユーザー相談の統合
  - ログ出力の統合
  - _Requirements: 既存の5ノードアーキテクチャとの統合_

### 3.3 設定ファイルの拡張

- [ ] `config/config.yaml` を修正
  - duck_pacemaker セクションの追加
  - dynamic_limits 設定の追加（enabled, min_loops, max_loops）
  - task_profiles 設定の追加（各タスクタイプのベース値）
  - フォールバック設定の追加
  - _Requirements: 設定値の分散改善_

### 3.4 設定管理クラスの拡張

- [ ] `codecrafter/base/config.py` を修正
  - DuckPacemakerConfig クラスの追加
  - 動的制限設定の取得メソッド追加
  - タスクプロファイル別設定の取得メソッド追加
  - _Requirements: 設定の外部化と管理_

## Phase 4: UI統合とユーザー体験

### 4.1 Rich UIとの統合

- [ ] `codecrafter/ui/rich_ui.py` を修正
  - 状況説明表示機能の追加
  - 4択選択肢の表示機能追加
  - ユーザー選択の入力処理追加
  - 進捗表示の改善（数値を隠した表示）
  - _Requirements: 直感的で理解しやすいUI_

### 4.2 ログシステムの統合

- [ ] ログ出力の統合実装
  - 開発者向け詳細ログの実装
  - ユーザー向けシンプル表示の実装
  - デバッグレベルでの詳細情報出力
  - _Requirements: 開発者とユーザーの両方に対応_

## Phase 5: テストとデバッグ

### 5.1 単体テストの実装

- [ ] `tests/test_simple_loop_calculator.py` を作成
  - 各タスクプロファイルでの計算テスト
  - バイタル状態による係数計算テスト
  - 複雑度による係数計算テスト
  - 制限範囲の適用テスト
  - _Requirements: 計算ロジックの正確性確認_

- [ ] `tests/test_simple_context_analyzer.py` を作成
  - ファイル数による複雑度計算テスト
  - 対話履歴による複雑度計算テスト
  - エラー率による複雑度計算テスト
  - 総合スコア計算テスト
  - _Requirements: 複雑度分析の正確性確認_

- [ ] `tests/test_simple_dynamic_pacemaker.py` を作成
  - 動的制限計算の統合テスト
  - フォールバック機能のテスト
  - 状況説明生成のテスト
  - セッション管理のテスト
  - _Requirements: システム全体の動作確認_

### 5.2 統合テストの実装

- [ ] `tests/test_dynamic_pacemaker_integration.py` を作成
  - 5ノードオーケストレーターとの統合テスト
  - 各タスクタイプでの動作確認テスト
  - バイタル状態変化による制限変更テスト
  - 介入パターンのテスト
  - _Requirements: 既存システムとの統合確認_

### 5.3 実動作テストの実施

- [ ] 実際のタスクでの動作確認
  - 各タスクプロファイルでの実行テスト
  - バイタル状態による制限変化の確認
  - ユーザー介入フローの確認
  - フォールバック機能の動作確認
  - _Requirements: 実用性の確認_

## Phase 6: ドキュメント整備

### 6.1 ユーザー向けドキュメント

- [ ] `docs/user_guide_dynamic_pacemaker.md` を作成
  - 動的制限システムの概要説明
  - 介入時の対処法ガイド
  - よくある質問と回答
  - _Requirements: ユーザーの理解促進_

### 6.2 開発者向けドキュメント

- [ ] `docs/developer_guide_dynamic_pacemaker.md` を作成
  - システムアーキテクチャの詳細
  - 拡張方法の説明
  - デバッグ方法の説明
  - _Requirements: 将来の拡張と保守性_

## Phase 7: 最終調整と最適化

### 7.1 パフォーマンス最適化

- [ ] 計算処理の最適化
  - 不要な計算の削除
  - キャッシュ機能の検討（必要に応じて）
  - メモリ使用量の最適化
  - _Requirements: システムパフォーマンスの維持_

### 7.2 設定値の調整

- [ ] 実使用データに基づく調整
  - タスクプロファイル別ベース値の微調整
  - バイタル係数の調整
  - 複雑度係数の調整
  - _Requirements: 実用性の向上_

### 7.3 エラーハンドリングの強化

- [ ] 例外処理の改善
  - 予期しないエラーへの対応
  - ログ出力の改善
  - ユーザーへのエラー通知改善
  - _Requirements: システムの安定性向上_

## 完了条件

- [ ] 全てのタスクプロファイルで動的制限が正しく計算される
- [ ] バイタル状態の変化が制限に適切に反映される
- [ ] 介入時にユーザーに分かりやすい状況説明が表示される
- [ ] フォールバック機能が確実に動作する
- [ ] 既存の5ノードアーキテクチャとの統合が完了している
- [ ] 全てのテストが成功する
- [ ] 実際の使用で期待通りの動作をする

## 注意事項

1. **シンプル第一**: 複雑な機能より確実な動作を優先
2. **段階的実装**: Phase 1から順番に実装し、各段階で動作確認
3. **既存システムとの互換性**: 既存機能を破壊しないよう注意
4. **テスト駆動**: 各機能の実装前にテストケースを明確化
5. **ユーザー体験重視**: 数値より状況説明を重視したUI設計