# [提案] 調査・分析フェーズの導入

**ID:** `PROPOSAL-001`  
**ステータス:** `提案`  
**作成日:** `2025-08-17`

---

## 1. 概要

コーディングタスクの計画立案精度とエージェントの自律性を向上させるため、計画立案フローの前に**調査・分析フェーズ**を明示的に導入することを提案します。

## 2. 関連フロー

- `flow.file_operation.v1.yaml`
- `flow.multi_step_task.v1.yaml`

## 3. 現状の課題

現在のフローでは、ユーザーの要求を受け取った後、すぐに計画立案 (`plan_tool.propose`) に移行します。しかし、多くの開発タスクでは、計画を立てる前に現状のコードを読んだり、関連ファイルを検索したりする「調査」が不可欠です。

この調査フェーズがないため、エージェントは不正確な情報に基づいて計画を立てるしかなく、以下のような問題が発生します。

- 見当違いの修正案を提示してしまう。
- ユーザーに「どのファイルを修正しますか？」といった追加情報を過度に要求してしまう。
- 結果として、エージェントの自律性が著しく低下し、ユーザーの手間が増える。

## 4. 提案内容

`plan_tool.propose` ステップの前に、新しい `investigation` ステップを追加します。

- **ステップ名:** `investigator.gather_context`
- **役割:** ユーザーの要求とプロジェクトの現状を分析し、計画立案に必要な情報を収集する。
- **具体的なアクション:**
    - `list_directory` でファイル構造を把握する。
    - `search_file_content` で要求に関連するコード箇所を特定する。
    - `read_file` で特定したファイルの内容を読み込み、コンテキストを理解する。
- **自律性:** これらのツールを、エージェントが自らの判断で複数回呼び出し、必要な情報が揃うまで調査を継続します。

## 5. 期待される効果

- **計画の精度向上:** エージェントが十分な情報に基づいて計画を立てるため、より的確な提案が可能になります。
- **自律性の向上:** ユーザーに質問する前に自ら情報を集めるため、エージェントがより自律的にタスクを進められるようになります。
- **ユーザー負担の軽減:** エージェントからの不要な質問が減り、ユーザーは本来の目的に集中できます。

## 6. 擬似的なFlowSpecの変更案

`flow.file_operation.v1.yaml` に以下のようなステップを追加します。

```yaml
# ... (routingなど)

steps:
  - id: s0 # << NEW STEP
    name: investigator.gather_context
    actor: investigator_tool
    inputs: [user_request]
    outputs: [context_summary, relevant_files]
    hint: ユーザー要求に基づき、関連ファイルを特定・読み込み、現状を把握する。

  - id: s1 # 旧s1
    name: plan_tool.propose
    actor: plan_tool
    inputs: [user_request, context_summary] # << context_summaryを入力に追加
    outputs: [plan_id]
    hint: 調査結果を基に、具体的な実行計画を立案する。

  - id: s2 # 旧s2
    name: plan_tool.set_action_specs
    # ... 以下続く
```
