# [提案] 長期的な学習サイクルの導入

**ID:** `PROPOSAL-004`  
**ステータス:** `提案`  
**作成日:** `2025-08-17`

---

## 1. 概要

エージェントが過去の経験から学び、継続的に賢くなるために、フローの実行結果を構造化して記録し、将来の意思決定に活用する**長期的な学習サイクル**を導入することを提案します。

## 2. 関連フロー

- `flow.duckflow_chat_flow.v1.yaml` (全体に関わる)
- その他すべてのサブフロー

## 3. 現状の課題

現在のフローは、その場限りの一回性のトランザクションとして設計されています。ある対話での成功や失敗、あるいはユーザーからのフィードバックが、次の新しい対話に活かされる仕組みが存在しません。

これにより、エージェントは同じような間違いを繰り返したり、特定のプロジェクトやユーザーのコーディングスタイルに適応したりすることができず、成長のない画一的な応答に留まってしまいます。

## 4. 提案内容

フローの完了時に**記憶を記録するステップ**を追加し、フローの開始時に**記憶を想起する**プロセスを組み込みます。

1.  **記憶の記録 (Memory Recording):**
    - **ステップ名:** `memory_updater.record_outcome`
    - **役割:** `flow.duckflow_chat_flow.v1.yaml` の最後にこのステップを追加します。
    - **記録内容:**
        - **タスクの要約:** 何をしようとしたか。
        - **実行された計画:** どのような手順を実行したか。
        - **結果:** 成功したか、失敗したか。失敗した場合のエラーは何か。
        - **ユーザーフィードバック:** （もしあれば）ユーザーからの修正指示や評価。
    - **保存先:** これらの情報を構造化データとして、長期記憶用のデータベース（例: ベクトルDB、SQLite）に保存します。

2.  **記憶の想起 (Memory Recall):**
    - **役割:** `analyze_intent` や `plan_tool.propose` などの意思決定ステップで、現在のタスクに類似した過去の記憶をデータベースから検索・参照します。
    - **活用方法:**
        - **計画立案:** 「以前、この種のエラーはXという方法で解決できた」という記憶を基に、より精度の高い計画を立てます。
        - **意図解釈:** 「このユーザーは『整理して』と言った時、import文の最適化を意図していることが多い」といったユーザーの癖に適応します。

## 5. 期待される効果

- **継続的なパフォーマンス向上:** エージェントが経験を積むごとに、より賢く、より効率的になります。
- **パーソナライゼーション:** ユーザーごと、プロジェクトごとの文脈やスタイルに適応し、真の「相棒」と呼べる存在に近づきます。
- **失敗からの学習:** 同じ間違いを繰り返さなくなり、エージェントの信頼性が向上します。

## 6. 擬似的なFlowSpecの変更案

`flow.duckflow_chat_flow.v1.yaml` に以下のような変更を加えます。

```yaml
# ...
steps:
  - id: s1
    name: receive_user_input
    # ...

  - id: s2
    name: analyze_intent
    actor: core
    inputs: [raw_input, episodic_memory] # << 長期記憶を入力に追加
    outputs: [action_type, intent_result]
    hint: 過去の対話履歴を参照し、意図解析の精度を向上させる。

  # ... (s3, s4)

  - id: s5
    name: output_to_user
    # ...

  - id: s6 # << NEW STEP
    name: memory_updater.record_outcome
    actor: memory_tool
    inputs: [session_id, flow_result, user_feedback]
    outputs: [memory_updated_status]
    hint: この対話での経験（成功/失敗/フィードバック）を長期記憶に保存する。
```
