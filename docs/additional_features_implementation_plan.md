# Duckflow v4: 追加機能・拡張実装計画 (Part 2)

## 概要
メインエージェント（Part 1）に対し、安全性、継続性、そして「相棒（Companion）」としての魂を吹き込むための計画です。
これらは Part 1 の安定稼働後に順次統合します。

---

## Step 5: 人間との協調 (Duck Call & Approval)
**目標:** 自律的な暴走を防ぎ、重要な判断をユーザーに委ねる。

- [ ] **Duck Call アクション**
    - LLMが自発的に「相談」を選べる `duck_call` アクションの実装。
- [ ] **承認システム (`companion/tools/approval.py`)**
    - ファイルの上書き・削除など、危険操作時の自動一時停止。
    - 差分（Diff）プレビューの表示機能。
- [ ] **UI統合**
    - Richを使用した承認待ち・選択肢のUI実装。

## Step 6: 健康管理 (D.U.C.K. Vitals)
**目標:** 無限ループや品質低下を動的に防ぐ。

- [ ] **バイタル計算ロジック**
    - ターンごとに `Mood` (自信), `Focus` (停滞度), `Stamina` (疲労度) を更新。
- [ ] **Pacemaker (`companion/core.py`)**
    - バイタル値に基づく強制介入ロジック（例：Stamina切れで休憩提案）。
- [ ] **ステータス表示**
    - ターミナルUIに現在のアヒル状態（🦆元気/疲労など）を表示。

## Step 7: 記憶と個性 (Memory & Persona)
**目標:** 長期的な文脈を維持し、ユーザーが愛着を持てる存在にする。

- [ ] **金魚の記憶プロトコル (Golden Fish Memory)**
    - 過去のタスク結果や会話を要約し、コンテキストウィンドウを節約する仕組み。
- [ ] **プロンプトの性格付け**
    - 事務的な応答から、v3哲学に基づいた「相棒」らしい口調への調整。
- [ ] **自己修正ループ**
    - 実行エラー時に、即座に諦めず、バイタルを消費して修正案を試すロジック。

## Step 8: 高度な探索 (Advanced Search - Optional)
**目標:** 大規模プロジェクトでも迷子にならない。

- [ ] **段階的ファイル探索**
    - `ripgrep` 等を用いた高速検索の統合（必要に応じて）。
    - 関連ファイルの推論ロジック強化。