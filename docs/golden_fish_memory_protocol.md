### **設計ドキュメント2：`Golden Fish Memory Protocol`**

**バージョン:** 1.0
**システム名:** `Golden Fish Memory Protocol`
**目的:** LLMの「忘れっぽい」という性質（ステートレス性）を前提とし、人間の記憶の仕組み（短期・中期・長期）を模倣した階層的な記憶システムを構築することで、コンテキストウィンドウの制約を超えた、長期的な文脈保持と経験からの学習を実現する。

#### **1. コンセプト：「忘れっぽさ」を補うための洗練された手順（プロトコル）**

「金魚の記憶力は3秒」という有名なジョークに基づき、`Duckflow`の記憶力も本質的には非常に短いことを認めます。しかし、このプロトコルに従うことで、金魚（AI）は、まるで人間のように過去の経験を思い出し、活用することができます。

#### **2. アーキテクチャ：3層の記憶階層**

`Golden Fish Memory Protocol`は、以下の3つのサブシステム（記憶階層）で構成されます。

##### **2.1. `The Bubble` (泡): 短期記憶 (`Atlas`システム)**
*   **役割:** 現在のタスクツリー。今まさに実行していること。
*   **データ:** `AgentState`内の`task_tree: Task`オブジェクト。
*   **寿命:** **揮発性。** セッション内で動的に変化し、セッションが終了すれば基本的には消える。
*   **特徴:** アクセスは最速だが、容量は非常に小さい（`QuackStack`の`capacity`で制限される）。

##### **2.2. `The Gravel Cache` (砂利の隠し場所): 中期記憶 (`Stash`システム)**
*   **役割:** 短期記憶から溢れた情報や、セッションをまたいで引き継ぎたい情報を一時的に退避させる。
*   **データ:**
    *   **タスクバックログ (`backlog.json`):** `Q.O.A.`によって退避されたタスク。
    *   **コンテキストページ (`context_pages/`):** 長すぎる対話履歴の詳細ログ。
    *   **セッションスナップショット (`sessions/`):** 直前の`AgentState`の状態。
*   **寿命:** **準揮発性。** 役割を終えたデータ（例: バックログから`Bubble`に戻されたタスク）は削除される。
*   **特徴:** 短期記憶より容量は大きいが、アクセスにはファイルI/Oが伴うため少し遅い。

##### **2.3. `The Castle` (お城): 長期記憶 (`Codex`システム)**
*   **役割:** プロジェクトを通じて得られた、再利用可能な「知識」と「経験則」を永続的に蓄積する。
*   **データ:**
    *   **成功した計画 (`successful_recipes.jsonl`)**
    *   **失敗と修正の記録 (`troubleshooting_guide.jsonl`)**
    *   **設計判断/規約 (`architecture_decision_log.md`)**
*   **寿命:** **永続性。** プロジェクトが存在する限り、蓄積され続ける知的資産。
*   **特徴:** AIの「思考の質」そのものを向上させるための、最も重要な記憶層。アクセスは主にRAG検索を通じて行われる。

#### **3. 記憶プロトコル（情報の流れ）**

1.  **入力:** ユーザーからの指示は、まず`The Bubble`（短期記憶）でタスクとして構造化される。
2.  **溢れ (Overflow):** `The Bubble`が溢れそうになると、`Q.O.A.`が発動し、優先度の低いタスクが`The Gravel Cache`（中期記憶）に退避される。
3.  **忘却 (Forgetting):** 対話履歴が長くなると、詳細が`The Gravel Cache`にページアウトされ、`The Bubble`には要約だけが残る。
4.  **想起 (Recollection):** AIが過去の詳細を必要とした場合、`The Gravel Cache`や`The Castle`からRAG検索で情報を探し出し、`The Bubble`に一時的にロードする。
5.  **学習 (Learning):** タスクが完了（あるいは失敗から成功に転換）した際、その経験から得られた普遍的な「教訓」が、`The Castle`（長期記憶）に刻み込まれる。

この`Golden Fish Memory Protocol`に従うことで、`Duckflow`は、その忘れっぽい性質を克服し、まるで経験豊かなベテラン開発者のように、過去の記憶を自在に操ることができるようになります。