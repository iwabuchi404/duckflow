# Duckflow Companion 承認システム ユーザーガイド

## 概要

Duckflow Companionには、ファイル操作やコード実行などの重要な操作を実行する前に、ユーザーの明示的な承認を求める承認システムが組み込まれています。このシステムにより、AIが予期しない操作を実行することを防ぎ、安全で信頼性の高い開発環境を提供します。

## 承認システムの特徴

### 🛡️ セキュリティ重視の設計
- すべての危険な操作（ファイル作成、編集、削除、コード実行）で承認が必要
- AIによる承認システムのバイパスを防止
- エラー時は常に安全側（操作拒否）に動作

### 🤝 自然な対話体験
- 相棒らしい自然な言葉での承認要求
- 操作の詳細と影響を分かりやすく説明
- 拒否時の代替案提案

### ⚙️ 柔軟な設定
- 3つの承認モード（STRICT、STANDARD、TRUSTED）
- 操作タイプ別の細かい設定
- プロジェクト固有の除外パス設定

## 承認モード

### STRICT（厳格）モード
```
🔒 最高レベルのセキュリティ
```
- **対象操作**: 低リスク以外のすべての操作
- **承認が必要**: ファイル作成、編集、削除、コード実行
- **承認不要**: ファイル読み取り、ディレクトリ一覧表示
- **推奨用途**: 本番環境、重要なプロジェクト

### STANDARD（標準）モード ⭐ デフォルト
```
🔐 バランスの取れたセキュリティ
```
- **対象操作**: 高リスク以上の操作
- **承認が必要**: ファイル作成、編集、削除、コード実行
- **承認不要**: ファイル読み取り、ディレクトリ一覧表示
- **推奨用途**: 日常的な開発作業

### TRUSTED（信頼）モード
```
🔓 最小限のセキュリティ
```
- **対象操作**: 重要リスク（システムファイル等）のみ
- **承認が必要**: システムファイルの変更、危険なコマンド実行
- **承認不要**: 通常のファイル操作、コード実行
- **推奨用途**: 個人プロジェクト、プロトタイピング

## 承認要求の例

### ファイル作成の承認要求
```
🤔 ちょっと相談があるのですが...

📝 **操作内容**
ファイル 'src/new_module.py' を作成 (内容: class NewModule:...)

🎯 **対象**: src/new_module.py
📊 **リスクレベル**: 🟡 高リスク
📄 **プレビュー**: 
class NewModule:
    def __init__(self):
        pass

この操作を実行してもよろしいですか？ (y/n): 
```

### 承認時の応答
```
✅ 承認いただきありがとうございます！
ファイル 'src/new_module.py' を作成しました。
```

### 拒否時の応答
```
分かりました。ファイル 'src/new_module.py' の作成は実行しません。

代わりに、ファイル内容をプレビューとして表示できます、または、
既存のファイルを参考にした設計案を提案することも可能です。どうしますか？
```

## 設定方法

### 承認モードの変更

#### コマンドラインから
```bash
# 標準モードに設定（デフォルト）
companion config approval-mode standard

# 厳格モードに設定
companion config approval-mode strict

# 信頼モードに設定
companion config approval-mode trusted
```

#### 設定ファイルから
`.companion/config.json`:
```json
{
  "approval": {
    "mode": "standard",
    "timeout_seconds": 30,
    "excluded_paths": [
      "temp/*",
      "*.tmp",
      ".git/*"
    ]
  }
}
```

### 除外パスの設定

特定のパスやファイルパターンを承認から除外できます：

```json
{
  "approval": {
    "excluded_paths": [
      "temp/*",           // tempディレクトリ全体
      "*.log",            // ログファイル
      "test_*.py",        // テストファイル
      ".git/*",           // Gitディレクトリ
      "node_modules/*"    // Node.jsモジュール
    ]
  }
}
```

## よくある質問

### Q: 承認要求がタイムアウトした場合はどうなりますか？
A: デフォルトで30秒後にタイムアウトし、安全のため操作が拒否されます。タイムアウト時間は設定で変更可能です。

### Q: 承認システムを完全に無効化できますか？
A: セキュリティ上の理由から、承認システムを完全に無効化することはできません。TRUSTEDモードで最小限の承認に設定することは可能です。

### Q: バッチ処理で複数の操作を一度に承認できますか？
A: 現在は各操作ごとに個別の承認が必要です。将来のバージョンでバッチ承認機能の追加を検討しています。

### Q: 承認履歴を確認できますか？
A: はい。`.companion/logs/approval.log`で承認履歴を確認できます。

### Q: エラーが発生した場合はどうなりますか？
A: 承認システムはフェイルセーフ設計のため、エラー時は常に操作を拒否します。詳細なエラー情報はログに記録されます。

## トラブルシューティング

### 承認要求が表示されない
1. 承認モードを確認: `companion config show approval-mode`
2. 除外パスに該当していないか確認
3. ログファイルでエラーを確認: `.companion/logs/approval.log`

### 承認が常に拒否される
1. UIコンポーネントが正しく動作しているか確認
2. タイムアウト設定を確認
3. 承認システムの再起動: `companion restart`

### パフォーマンスが遅い
1. 除外パスを適切に設定
2. 不要な承認要求を減らすためTRUSTEDモードを検討
3. ログレベルを調整

## セキュリティのベストプラクティス

### 🔐 推奨設定
- **本番環境**: STRICTモード
- **開発環境**: STANDARDモード
- **個人プロジェクト**: STANDARD または TRUSTEDモード

### 🚨 注意事項
- 承認要求は慎重に確認してから承認してください
- 不明な操作や予期しない操作は拒否してください
- 定期的に承認履歴を確認してください
- システムファイルの操作は特に注意してください

### 📝 監査とログ
- すべての承認要求と結果がログに記録されます
- ログファイルは定期的にバックアップしてください
- 異常な承認パターンがないか定期的に確認してください

## サポート

承認システムに関する問題や質問がある場合：

1. **ドキュメント**: このガイドと[技術仕様書](approval_system_technical_spec.md)を確認
2. **ログ確認**: `.companion/logs/approval.log`でエラー詳細を確認
3. **設定確認**: `companion config show`で現在の設定を確認
4. **リセット**: `companion config reset approval`で設定をリセット

---

*このガイドは Duckflow Companion v2.0 の承認システムに基づいています。*
*最新の情報については、公式ドキュメントを参照してください。*