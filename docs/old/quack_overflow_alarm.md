### **設計ドキュメント1：`Quack Overflow Alarm (Q.O.A.)` システム**

**バージョン:** 1.0
**システム名:** `Quack Overflow Alarm` (略称: `Q.O.A.`)
**目的:** AIエージェントの短期記憶（ワーキングメモリ）の認知的負荷を管理し、その容量を超えそうな場合に、ユーザーとの協調的な対話を通じてタスクの優先順位付けと整理を行う、対話型タスク管理システムを定義する。

#### **1. コンセプト：AIの「思考の飽和」を防ぐ警報**

`Q.O.A.`は、プログラミングにおける「スタックオーバーフロー」の概念をメタファーとしています。AIが一度に多くのタスクを計画しようとして思考が飽和状態に陥る（＝スタックが溢れる）前に、警報（Alarm）を鳴らし、ユーザーに助けを求めることで、エージェントの安定したパフォーマンスを維持します。

#### **2. アーキテクチャ上の位置づけ**

*   `Q.O.A.`は、主に`1️⃣理解・計画ノード`内部で動作する、一連のロジックと、それに続く`Oracle`システム（汎用質問システム）の特定の使用パターンです。
*   トリガーは、計画立案フェーズでのサブタスク数の見積もりに基づきます。

#### **3. 主要コンポーネントとデータ構造**

*   **短期記憶スタック (`QuackStack`):**
    *   `AgentState`内に`quack_stack: List[Task]`として定義される。
    *   現在進行中および未着手の、具体的なサブタスクを保持する。
*   **スタック容量 (`capacity`):**
    *   `config.yaml`で定義される、`QuackStack`が保持できるタスク数の上限（例: `7`）。
*   **スクラムマスターAI (サブタスクLLM):**
    *   `LLMService`内に`generate_task_organization_proposal`メソッドとして実装。
    *   `Q.O.A.`が発動した際に、ユーザーへの状況説明と解決策の選択肢を生成することに特化したAI。

#### **4. 処理フロー**

1.  **[トリガー]** `1️⃣理解・計画ノード`が、ユーザーの新しい要求をサブタスクに分解した結果、`len(state.quack_stack) + len(new_sub_tasks) > capacity` となることを検知。
2.  **[Q.O.A.発動]** 通常の計画立案を中断し、`LLMService.generate_task_organization_proposal`を呼び出す。この際、現在の`quack_stack`の内容と、新しく追加しようとしているタスクのリストをコンテキストとして渡す。
3.  **[提案生成]** スクラムマスターAIが、状況を説明し、複数の解決策（優先順位の入れ替え、外部記憶への待避など）を含む`OracleQuery`オブジェクトを生成する。
4.  **[ユーザーへの相談]** 生成された`OracleQuery`が`AgentState`にセットされ、`Oracle`システムが起動。ユーザーに状況が報告され、意思決定が求められる。
5.  **[解決]** ユーザーの選択に基づき、`QuackStack`の内容が整理され（例: 一部のタスクが`The Scribe`によってバックログに書き出される）、メインの処理ループが再開される。

---
