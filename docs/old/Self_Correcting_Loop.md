### ：自己修正ループ思考 (Self-Correcting Loop) 設計ドキュメント

#### 1. 概要 (Overview)

本ドキュメントでは、`Duckflow`がタスク遂行中に発生するエラーから自動的に学習し、改善するための、自己修正ループの設計について解説します。

#### 2. なぜ自己修正ループが必要なのか？ (Motivation)

*   **不確実な環境:** コーディングタスクは、依存関係のエラー、APIの変更、予期せぬファイル構造など、様々な要因で失敗する可能性があります。
*   **完璧な計画の非現実性:** どんなに優れた計画立案AIでも、常に完璧な計画を立てられるとは限りません。
*   **ユーザーの負担軽減:** エージェントが自律的にエラーを修正できれば、ユーザーは何度も指示を修正したり、詳細なデバッグ情報を提供したりする必要がなくなります。

#### 3. アーキテクチャ (Architecture)

自己修正ループは、`LangGraph`の柔軟なグラフ構造と、`LLMService`を組み合わせることで実現します。

*   **主要な要素:**
    *   **`AgentState`:** 全ての情報を保持する、中央集権的な記憶。
    *   **評価ノード (`4️⃣評価・継続ノード`):** 実行結果を分析し、エラーの原因を特定する。
    *   **計画立案ノード (`1️⃣理解・計画ノード`):** エラー情報を基に、修正された計画を立案する。
    *   **LLMService:** 評価や計画立案など、各タスクに特化したLLMへのアクセスを提供する。

#### 4. 自己修正ループの具体的な流れ

1.  **タスク実行:** 計画されたタスク（例: ファイルの編集）を実行します。
2.  **エラー検知:** ツール実行エンジンが、エラーを検知します。
3.  **`AgentState`更新:** エラーの種類、エラーメッセージ、スタックトレースなどの情報を、`AgentState`に記録します。
4.  **評価ノード:**
    *   `LLMService`を呼び出し、エラーの内容、実行されたタスク、プロジェクトのコンテキストなどを伝え、**エラーの原因を分析**させます。
    *   AIは、`"原因: 必要なライブラリがインストールされていない"`のような分析結果と、`next_action: RETRY_WITH_FIX`、`continuation_context: "pip install <ライブラリ名> を実行"`のような指示を返します。
5.  **状態更新:** `AgentState`に、エラー分析の結果と、再試行のためのコンテキストを保存します。
6.  **計画立案ノード:**
    *   `LLMService`を呼び出し、`AgentState`から、元のタスク、過去の計画、そして**エラー分析の結果**を伝え、新しい計画を立てさせます。
    *   AIは、過去の失敗を踏まえ、より確実な成功が見込めるような計画を立案します。
        > 例: 以前の計画が「`write_file(main.py)`」だった場合、新しい計画は「`pip install <必要なライブラリ>` → `write_file(main.py)`」のように、エラーを解決するためのステップが追加されます。
7.  **タスク再実行:** 新しい計画に基づき、タスクを再度実行します。

#### 5. 考慮すべき点

*   **無限ループの防止:** 前述の通り、`retry_count`や「思考の停滞」検知などの安全機構を必ず実装します。
*   **エラー情報の詳細さ:** LLMに与えるエラーメッセージは、可能な限り詳細であるほど、AIは正確な原因を特定しやすくなります。スタックトレース全体や、関連するログファイルの内容を含めることも検討します。
*   **再試行戦略の多様性:** 常に同じ方法で再試行するのではなく、複数の解決策を試すように促します。例えば、「別のライブラリを使う」「より安全なAPIを使う」「より詳細な情報をWebで検索する」といった選択肢をAIに提示します。

#### 6. 今後の展望

*   **「成功」からの学習:** エラーだけでなく、成功したタスクの実行プロセスも分析し、より効率的なコーディングパターンを学習する。
*   **人間の介入:** エージェントがどうしても解決できない問題に直面した場合、人間の開発者に詳細なレポート（エラー内容、試した解決策、提案される次のステップ）を提示し、指示を仰ぐ。

この自己修正ループを実装することで、`Duckflow`は単なるツールではなく、経験を通して成長し続ける、真に賢い開発パートナーへと進化します。