### **設計ドキュメント：`The Duck Keeper` - 統合アクセス制御システム**

**バージョン:** 3.0
**システム名:** `The Duck Keeper` (ダック・キーパー)
**目的:** `Duckflow`の全てのファイルシステム操作（ポリシー管理、探索、アクセス）を、統一されたルールに基づき、効率的かつ安全に実行するための、包括的なシステムを定義する。

#### **1. コンセプト：プロジェクトを守る賢明な「管理人」**

`The Duck Keeper`は、`Duckflow`が無秩序にファイルシステムをさまよったり、危険なファイルに触れたりするのを防ぐ、賢明な管理人です。`The Duck Keeper`は、**「何を（`What`）見ても良いか」というアクセスポリシーを一元管理**し、そのポリシーを、`Duck Scan`（探索ツール）と`Duck FS`（ファイル操作ツール）の両方に強制します。

#### **2. `The Duck Keeper`の主要コンポーネント**

`The Duck Keeper`は、1つの「ポリシー定義」と、2種類の「ツールセット」から構成されます。

1.  **アクセスポリシー (Access Policy):**
    *   **責務:** ファイルアクセスに関する全てのルールを`config.yaml`内で一元管理する。
    *   **設定場所:** `config.yaml`内の`duck_keeper`セクション。
    *   **ポリシー項目:**
        *   `allowed_extensions`: 拡張子ホワイトリスト（例: `[".py", ".md", ".json"]`）。
        *   `directory_blacklist`: 常に無視すべきディレクトリのリスト（例: `[".git", ".idea", "node_modules"]`）。
        *   `enforce_workspace_boundary`: プロジェクト外へのアクセスを禁止するか (`true`)。
        *   `respect_gitignore`: `.gitignore`ファイルを尊重するか (`true`)。

2.  **`Duck Scan` - フォルダ探索ツール群:**
    *   **責務:** `The Duck Keeper`のアクセスポリシーに従い、**「どこを探すべきか」**というファイル候補リストを、安全かつ効率的に生成する。

3.  **`Duck FS` - ファイル操作ツール群:**
    *   **責務:** `The Duck Keeper`のアクセスポリシーに従い、個別のファイルI/O操作を安全に実行する。

---

#### **3. `Duck Scan`の詳細仕様**

`Duck Scan`は、`1️⃣理解・計画ノード`が、調査計画の一環として呼び出す、インテリジェントな探索ツール群です。

*   **配置:** `tools/duck_scan.py`
*   **主要なツール:**

    *   **`scan_workspace(query: str) -> List[str]`:**
        *   **役割:** プロジェクト全体を対象とした、統合的な初期探索ツール。
        *   **内部パイプライン:**
            1.  **ポリシー適用:** `The Duck Keeper`の`config.yaml`をロード。
            2.  **フィルタリング:** `directory_blacklist`と`.gitignore`ルールに基づき、探索対象外のパスを決定。
            3.  **キーワード検索:** `query`からキーワードを抽出し、超高速検索ツール`ripgrep`を呼び出す。検索対象は`allowed_extensions`に限定。
            4.  **階層的スキャン（フォールバック）:** キーワード検索で結果が得られない場合、ルート→サブディレクトリと段階的にスキャン。
            5.  **最終フィルタリング:** 全てのステップで得られたファイル候補に対し、再度`The Duck Keeper`の全ポリシーを適用し、安全性を保証。
            6.  **出力:** 優先順位付けされた、安全なファイルパスのリストを返す。

    *   **`scan_directory(path: str, recursive: bool = False) -> List[str]`:**
        *   **役割:** 特定のディレクトリ配下を、安全にリストアップする深掘り調査ツール。
        *   **ポリシー連携:** リストアップされる全てのファイルは、`The Duck Keeper`のポリシーでフィルタリングされる。

---

#### **4. `Duck FS`の詳細仕様**

`Duck FS`は、実際のファイルI/Oを担当する、基本的なツール群です。

*   **配置:** `tools/duck_fs.py`
*   **共通の安全規約:**
    *   全てのツールは、処理の最初に、必ず`The Duck Keeper`のポリシーと照合し、**実行時検証**を行う。
    1.  **ワークスペース境界チェック:** パスがプロジェクト内に収まっているか検証。
    2.  **拡張子ホワイトリスト再チェック:** 拡張子が許可されているか再検証。

*   **主要なツールと詳細仕様:**

    *   **`read(path: str) -> FileReadResult`:**
        *   **役割:** ファイルの先頭から、トークン数上限までを読み込む。
        *   **制限:** `config.yaml`の`max_file_read_tokens`設定を適用する。
        *   **戻り値:** `FileReadResult`オブジェクト（`content`, `read_percentage`などを含む）。

    *   **`read_range(path: str, start_line: int, end_line: int) -> FileReadResult`:**
        *   **役割:** 指定された行範囲のファイル内容を正確に読み込む。

    *   **`get_summary(path: str) -> FileReadResult`:**
        *   **役割:** 巨大なファイルの**構造と概要**を、トークンを節約しつつ把握する。
        *   **処理:**
            *   ソースコードの場合: `tree-sitter`で関数/クラス単位に分割し、`Librarian`ロールのAIで要約。
            *   ドキュメントの場合: `RecursiveCharacterTextSplitter`で段落単位に分割し、要約。
            *   JSON/Logの場合: 統計情報（オブジェクト数、スキーマ、サンプル）を生成。

    *   **`write(path: str, content: str) -> Dict`:**
        *   **役割:** `1️⃣計画ノード`が生成した内容を、ファイルシステムに安全に書き込む。

---

### **5. 統合ワークフロー**

1.  **計画:** `1️⃣理解・計画ノード`は、調査が必要な場合、その計画に**「`duck_scan.scan_workspace`ツールを呼び出す」**というステップを組み込む。
2.  **実行 (探索):** `3️⃣安全実行ノード`が、計画に従い、`duck_scan.scan_workspace`ツールを呼び出す。
3.  **`Duck Scan`の内部動作:** `scan_workspace`は、**`The Duck Keeper`のポリシー**に従って、安全なファイル候補リストを生成し、結果として返す。
4.  **評価と再計画:** `4️⃣評価・継続ノード`が、`Duck Scan`の結果を受け取り、`1️⃣理解・計画ノード`が、そのリストを基に、**「次にどのファイルを`duck_fs.read`で読むか」**という、より詳細な次の計画を立てる。
5.  **実行 (アクセス):** `3️⃣安全実行ノード`が、新しい計画に従い、`duck_fs.read`ツールを呼び出す。
6.  **`Duck FS`の内部動作:** `read`ツールは、実行の直前に、再度**`The Duck Keeper`のポリシー**と照合して、アクセスの安全性を最終確認してからファイルを開く。

この**「計画→ツール実行→評価→再計画」**という明確なループと、**`The Duck Keeper`**という統一されたポリシー管理システムにより、`Duckflow`のファイルシステムとのインタラクションは、高度なインテリジェンスと、妥協のない安全性を両立させることができます。