### **設計ドキュメント：`Duck Scriptwriter` - 応答生成AI**

**バージョン:** 1.0
**システム名:** `Duck Scriptwriter` (ダック・スクリプトライター)
**目的:** システム内部で収集・構造化された無機質な「データ」を、ユーザーの要求（`TaskType`）に応じて、論理的で、洞察に満ちた、プロフェッショナルな「情報（＝脚本）」へと変換する、専門のサブタスクLLMと思考プロセスを定義する。

#### **1. コンセプト：AIの思考を「脚本」に起こす専門家**

`Duck Scriptwriter`は、`Duckflow`の思考プロセスの最終段階に登場する、冷静沈着な「脚本家」です。彼の仕事は、`Duck Roleplay Converter`という名優（演出家）が最高の演技をするための、完璧な「脚本（無機質なレポート）」を書き上げることです。彼は、ユーモアや感情を交えず、事実と論理のみに基づいて、最高の物語の骨子を構築します。

**最重要原則:** `Duck Scriptwriter`が生成するアウトプットは、**常に客観的で、プロフェッショナルで、キャラクター性を含まない**、整然としたMarkdown文字列でなければならない。

#### **2. アーキテクチャ上の位置づけ**

*   `Duck Scriptwriter`は、**`5️⃣応答生成ノード`**の内部で呼び出される、**`LLMService`**の専門メソッド（例: `generate_script`）として実装される。
*   彼は、4ノードサイクルで収集・生成された全ての情報をインプットとして受け取り、ユーザーに提示されるべき最終的な「成果物」の**素案**を生成する、パイプラインの最終思考エンジンである。

#### **3. データフローと主要コンポーネント**

```
+--------------------------+     +------------------------+
| 5️⃣応答生成ノード        | --> | LLMService.            |
| (オーケストレーターの一部) |     | generate_script(...)   |
+--------------------------+     | (Duck Scriptwriter)|
          ^                      +------------+-----------+
          | (1. 収集済みデータ)               | (2. 脚本生成)
+---------+------------------+               |
| AgentState & GatheredInfo|               |
| (全ての材料)             |               v
+--------------------------+     +------------------------+
                                 |  "Script" (無機質なレポート) |
                                 +------------+-----------+
                                              | (3. 演出へ)
                                              v
                                 +--------------------------+
                                 | Duck Roleplay Converter  |
                                 +--------------------------+
```

#### **4. `Duck Scriptwriter` (LLMService.generate_script) の詳細仕様**

*   **役割:** 構造化されたデータを、指定されたテンプレート構造に基づき、自然言語のレポートへと変換する。
*   **使用するLLMロール:** **`Developer`** or **`Librarian`**
    *   創造性よりも、**論理的な構成力**と**情報の正確性**が求められるため、`Architect`（最も高価）である必要はない。`Claude 3.5 Sonnet`や`GPT-4o`のような、バランスの取れた高性能モデルが最適。
*   **入力:**
    *   `user_original_request: str`
    *   `task_type: TaskType` (6分類のいずれか)
    *   `extracted_data: Dict[str, Any]` (ステージ1で収集・構造化されたデータ)
    *   `raw_file_contents: Dict[str, str]` (分析の元となった生のファイル内容)
*   **プロンプト設計:**
    *   プロンプトは、`task_type`に応じて動的に変化する。
    *   **共通の指示:**
        > 「あなたは、AIエージェント`Duckflow`の技術文書を作成する、専門の`Duck Scriptwriter`です。
        > あなたの仕事は、与えられた構造化データと生の情報を基に、ユーザーの要求に完璧に応える、**客観的で、プロフェッショナルで、論理的なレポート（脚本）**を生成することです。
        >
        > **【厳守事項】**
        > - キャラクター性やユーモア、感情的な表現は**一切含めないでください。**
        > - 以下の「出力テンプレート」の構造に厳密に従い、各セクションをあなた自身の言葉で、自然な文章として埋めてください。単にデータを貼り付けるだけではいけません。
        > - 全ての記述は、提供された「構造化データ」と「生のファイル内容」に完全に基づかなければなりません。」

    *   **動的に変化する部分:**
        > **【ユーザーの最終的な要求】**
        > `{user_original_request}`
        >
        > **【あなたが利用できる、構造化されたデータ】**
        > ```json
        > {extracted_data}
        > ```
        >
        > **【参考資料：生のファイル内容】**
        > `{raw_file_contents}`
        >
        > **【出力テンプレート】**
        > (ここに、`task_type`に応じた`template_structure`が挿入される)
*   **出力:**
    *   **`Script` (脚本):** テンプレートに従って生成された、キャラクター性を含まない、プロフェッショナルなMarkdown文字列。

#### **5. テンプレート構造 (`template_structure`) との連携**

*   `Duck Scriptwriter`の成功は、各`TaskType`に定義された`template_structure`の質に大きく依存する。
*   `1️⃣計画ノード`は、`TaskType`を決定すると同時に、この**応答テンプレートも決定**し、`AgentState`に記録しておく。
*   `5️⃣応答生成ノード`は、その`AgentState`からテンプレートを取り出し、`Duck Scriptwriter`に渡す。

**例 (`ANALYSIS_REQUEST`の場合):**
1.  `計画ノード`が「このタスクは`ANALYSIS_REQUEST`だ。最終的なアウトプットは『現状評価』『発見事項』『推奨改善策』のセクションを持つべきだ」と決定する。
2.  `情報収集ノード`が、分析に必要なデータを集める。
3.  `応答生成ノード`が、`Duck Scriptwriter`を呼び出す。
4.  `Duck Scriptwriter`は、収集されたデータを基に、「現状評価」「発見事項」「推奨改善策」の各セクションを、**専門家としての客観的な文章で**埋めていく。

この設計により、`Duckflow`は、**「何を言うか（論理）」**と**「どう言うか（個性）」**を、システムの全く異なるレイヤーで、それぞれ専門のAIに担当させることができます。`Duck Scriptwriter`は、その「何を言うか」という部分の品質を保証する、極めて重要な役割を担うのです。