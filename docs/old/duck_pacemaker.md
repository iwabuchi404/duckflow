### **設計ドキュメント2（改訂版）：`duckPacemaker` - 動的ループ制御システム**

**バージョン:** 2.1
**システム名:** `duckPacemaker`
**目的:** AIエージェントという長距離ランナーが、暴走（オーバーペース）や失速（停滞）をしないよう、その健康状態（バイタル）を常に監視・調整する、内部的な伴走者を定義する。

#### **1. コンセプト：AIのパフォーマンスを維持する伴走者**

`duckPacemaker`は、`Duckflow`の思考ループが健全なペースで進んでいるかを監視します。ペースが乱れていると判断すると、AIに休息（ユーザーへの相談）を促したり、走行プラン（計画）の見直しを指示したりします。これは、AIの無限ループを防ぎ、最高のパフォーマンスを引き出すための自己制御メカニズムです。

#### **2. アーキテクチャ上の位置づけ**

*   `duckPacemaker`は、`LangGraph`の**分岐ロジック（`_decide_next_node`）**と、`4️⃣評価・継続ノード`に組み込まれる、一連のルールと判断機構の総称である。

#### **3. 主要コンポーネント: `D.U.C.K. Vitals System`（アヒル健康診断）**

*   **`duckPacemaker`は、`D.U.C.K. Vitals System`から提供されるデータを唯一の判断基準として動作します。** このバイタルシステムは、`duckPacemaker`にとっての「計器盤」あるいは「心拍計」です。
*   `4️⃣評価・継続ノード`は、毎ターンの終わりに以下の3つのバイタルサインを計算し、`AgentState`を更新します。`duckPacemaker`は、この更新された値を監視します。
    1.  **`Mood` (気分/自信):** AIの自己評価に基づく確信度。
    2.  **`Focus` (集中力):** 思考の一貫性、停滞の度合い。
    3.  **`Stamina` (体力):** 総ループ回数やエラー発生回数に基づく消耗度。

#### **4. 制御ロジック**

`_decide_next_node`関数は、`duckPacemaker`の判断として、`AgentState`内の**`Vitals`オブジェクトの値を監視**し、それに応じて次の行動を決定します。

*   **`Stamina`が危険水域の場合（例: `< 0.1`）:**
    *   **判断:** ランナー（AI）が消耗しきっており、これ以上の走行は危険。
    *   **アクション:** 強制的に`Duck Call`を発信し、ループを中断させる（物理的安全装置）。

*   **`Focus`が低下している場合（例: `< 0.3`）:**
    *   **判断:** ランナーが集中力を失い、同じ場所をぐるぐる回っている（思考が停滞している）。
    *   **アクション:** `REPLAN`を促し、`1️⃣理解・計画ノード`に戻して、走行ルート（計画）を根本から見直させる。

*   **`Mood`が低い場合（例: `< 0.7`）:**
    *   **判断:** ランナーが、前方のコース（次の計画ステップ）に対して自信をなくしている。
    *   **アクション:** `Duck Call`を発信し、AIが不確実な判断を単独で下す前に、コーチ（ユーザー）に「このまま進んでもいいですか？」と相談させる。

*   **全てのバイタルが健全な場合:**
    *   **判断:** ランナーは快調。
    *   **アクション:** 計画通り、次のステップ（`CONTINUE`）に進む。