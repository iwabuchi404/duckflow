### **設計ド-キュメント: `D.U.C.K. Vitals System` - アヒル健康診断システム**

**バージョン:** 1.0
**目的:** エージェントの内部的な認知状態を、複数の健康指標（バイタル）として定量化・可視化する。これにより、エージェントの自律的な行動をより安全かつインテリジェントに制御し、ユーザーに直感的で楽しいフィードバックを提供する。

#### **1. コンセプト：アヒルの健康診断**

`Duckflow`は、長時間働いたり、難しい問題に直面したりすると「疲れる」生き物です。この`D.U.C.K. Vitals System`は、エージェントの「健康状態」を3つの主要なバイタルサインで監視する健康管理システムです。これらのバイタルが悪化すると、アヒルは無理をせず、より慎重になったり、獣医（ユーザー）に相談したりします。

#### **2. 3つの主要バイタルサイン (The Vitals)**

`AgentState`内に、`Vitals`というPydanticモデルとして実装されます。

```python
class Vitals(BaseModel):
    mood: float = 1.0       # 気分・機嫌
    focus: float = 1.0      # 集中力
    stamina: float = 1.0    # 体力
```

##### **① `Mood` (気分・機嫌)**
*   **コンセプト:** AIが、現在のタスクや計画に対してどれだけ「自信」を持っているか、その**主観的な確信度**を示します。
*   **スケール:** `1.0` (ノリノリ 😎) 〜 `0.0` (しょんぼり 😔)
*   **主な変動要因:**
    *   **AI自身の自己評価**が直接反映されます。計画立案時や評価時に、AIが出力する`confidence_score`がこの値のベースとなります。
    *   ユーザーからの肯定的なフィードバック（将来機能）で上昇。
*   **有用性:**
    *   **`Oracle`システムの起動トリガー。** `mood`が一定値（例: `0.7`）を下回ると、AIは自信がないと判断し、「ちょっと相談いいですか...？」とユーザーに助けを求めます。

##### **② `Focus` (集中力)**
*   **コンセプト:** AIが、現在のタスクに対してどれだけ「脇道に逸れずに」取り組めているか、その**思考の一貫性**を示します。
*   **スケール:** `1.0` (ゾーン状態 🧘) 〜 `0.0` (注意散漫 😵)
*   **主な変動要因:**
    *   **上昇要因:** サブタスクが順調に完了する。
    *   **下降要因:** **思考の停滞**（同じような計画の繰り返し）、**コンテキストの肥大化**（プロンプトが長すぎる）、**ユーザーからの大幅な方針転換**。
*   **有用性:**
    *   **再計画（REPLAN）のトリガー。** `focus`が一定値（例: `0.3`）を下回ると、AIは「今のアプローチでは考えがまとまらない！」と判断し、一度立ち止まって計画を根本から練り直す（`REPLAN`）ようになります。
    *   プロンプトに「現在、集中力が低下しています。よりシンプルで直接的な計画を立ててください」という指示が追加されます。

##### **③ `Stamina` (体力)**
*   **コンセプト:** AIが、タスク全体に対してどれだけの「試行錯誤」を行ったか、その**物理的な消耗度**を示します。
*   **スケール:** `1.0` (元気いっぱい 💪) 〜 `0.0` (ヘトヘト 💀)
*   **主な変動要因:**
    *   **下降要因:** **総ループ回数**、**ツールエラーの発生回数**。
*   **有用性:**
    *   **物理的な安全装置。** `stamina`が一定値（例: `0.1`）を下回ると、`Aegis`システムが作動し、強制的にループを停止させ、`Oracle`を通じてユーザーに「もう限界です...」と報告します。無限ループを防ぐ最後の砦です。

#### **3. アーキテクチャへの統合**

*   **`AgentState`:** `Vitals`モデルを`AgentState`に含めます。
    ```python
    class AgentState(BaseModel):
        # ...
        vitals: Vitals = Field(default_factory=Vitals)
    ```
*   **`4️⃣評価・継続ノード`:** このノードの主な責務の一つが、ループの最後に**バイタルを更新する**ことになります。ツールの実行結果、AIの自己評価、ループ回数などを基に、各バイタル値を再計算します。
*   **`_decide_next_node` (分岐ロジック):** この関数は、3つのバイタル値を総合的に見て、次の行動を決定します。
    ```python
    def _decide_next_node(state: AgentState) -> str:
        vitals = state.vitals
        
        if vitals.stamina < 0.1:
            return "ask_user_halt_node" # 体力切れで強制相談

        if vitals.focus < 0.3:
            return "understanding_node" # 集中力切れで再計画(REPLAN)

        if vitals.mood < 0.7:
            return "ask_user_confirm_node" # 自信喪失で相談

        # ...通常の継続・完了ロジック...
    ```

#### **4. UI/UXへのフィードバック：アヒルの健康診断レポート**

ユーザーが`status`コマンドを叩いたときや、`Oracle`が起動した際に、現在のバイタルを分かりやすく表示します。

*   **ステータスバー:**
    ```
    [ Duckflow | Mood: 😎(0.92) | Focus: 🧘(0.85) | Stamina: 💪(0.98) ]
    ```
    問題発生時:
    ```
    [ Duckflow | Mood: 😔(0.65) | Focus: 😵(0.25) | Stamina: 🤕(0.40) ]
    ```

*   **`Oracle`での相談:**
    > **🦆...「獣医さん（ユーザー）！ちょっと診てください！」**
    >
    > **【アヒル健康診断レポート】**
    > - **気分 (Mood):** **65% (少し不安)** - 現在の計画にあまり自信が持てません。
    > - **集中力 (Focus):** **25% (注意散漫)** - 同じようなことを繰り返しており、考えがまとまりません。
    > - **体力 (Stamina):** **40% (消耗気味)** - エラーが多発しています。
    >
    > **ドクター（AI）の所見:**
    > 現在のアプローチは非効率で、失敗する可能性が高いと判断します。一度計画をリセットし、全く別のアプローチを試すことを推奨します。
    >
    > **どうしますか？**
    > 1.  **治療方針の指示 (詳細指示)**
    > 2.  **セカンドオピニオン (代替手法)**
    > 3.  **安静にする (中断)**

この`D.U.C.K. Vitals System`は、エージェントの複雑な内部状態を、誰にでも親しみやすい「健康」というメタファーで表現することで、**ユーザーとの間に強い共感と信頼関係を築く**、極めてユニークで強力なシステムとなるでしょう。