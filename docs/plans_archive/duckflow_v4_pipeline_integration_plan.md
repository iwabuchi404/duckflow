# ドキュメント：v4.1 計画の記憶と連携の強化・実装指示書

## 1. 概要

### 1.1. 目的
本改修の目的は、前回実装した階層的プランニング機能の課題を解決することです。具体的には、以下の2点を実現します。
1.  **計画の記憶:** エージェントが生成した長期計画を対話ターンをまたいで記憶し、一貫したタスク遂行を可能にする。
2.  **アクション間のデータ連携:** 1回の思考で生成された複数のアクション間で、前の結果を後の入力として利用できるパイプライン機能を実装する。

### 1.2. 主な対象ファイル
*   `companion/enhanced_core_v8.py`: プロンプト生成ロジックと、アクション実行ロジック（ディスパッチャ）の改修

### 1.3. 参照ファイル
*   `companion/state/agent_state.py`: コンテキストデータの参照元

## 2. 実装ステップ

### ステップ1: プロンプトのコンテキスト継続性の強化

**担当ファイル:** `companion/enhanced_core_v8.py`
**担当メソッド:** `_generate_hierarchical_plan`

**タスク:**
LLMが既存のプランを認識し、それを踏まえて次の行動を決定できるように、プロンプトを動的に変更するロジックを実装します。

1.  `_generate_hierarchical_plan` メソッドのプロンプト生成部分を修正します。
2.  プロンプト内の「現在の状況」セクションを、`self.agent_state.active_plan_id` の有無に応じて、以下のように動的に構築してください。

    *   **`active_plan_id` が存在する場合:**
        *   `_get_current_plan_summary()` の出力を表示します。
        *   その下に、以下の指示を追加してください。
            > **指示**: 現在、上記のプランが進行中です。ユーザーの要求がこのプランの継続であるか、または関連するものであるかを検討してください。新しいプランを提案するのは、ユーザーが明確に指示した場合のみにしてください。

    *   **`active_plan_id` が存在しない場合:**
        *   以下の指示を追加してください。
            > **指示**: 現在進行中の長期プランはありません。ユーザーの要求が複雑な場合は、`plan_tool.propose` を使用して新しいプランを作成することを検討してください。

### ステップ2: アクション間データ連携パイプラインの実装

**担当ファイル:** `companion/enhanced_core_v8.py`

**タスク:**
`ActionList` 内のアクション間で結果を連携させるパイプライン機能を実装します。これにより、例えば `read_file` の結果を `generate_response` に渡すことが可能になります。

1.  `_handle_action_execution` 内の `for action in action_list:` ループ部分を、`_dispatch_actions` という新しい非同期メソッドにリファクタリングしてください。
2.  `_dispatch_actions` の先頭で、そのターン内の実行結果を保存するための一時的な辞書 `turn_results: Dict[str, Any] = {}` を初期化します。
3.  アクションを実行するループの中で、各アクションの `args` を処理する前処理ステップを追加します。
4.  `_preprocess_action_args(self, args: Dict[str, Any], turn_results: Dict[str, Any]) -> Dict[str, Any]` というヘルパーメソッドを新規に作成します。このメソッドは、引数の値が `"ref:some_id"` という形式の文字列の場合、`turn_results` から `some_id` に対応する実行結果を取り出して値を置き換える役割を担います。
5.  アクション実行後、そのアクションに `action_id` が設定されていれば、`turn_results[action.action_id] = raw_result` のように実行結果を保存します。

### ステップ3: プロンプトへのデータ連携機能の説明追加

**担当ファイル:** `companion/enhanced_core_v8.py`
**担当メソッド:** `_generate_hierarchical_plan`

**タスク:**
LLMがデータ連携パイプライン機能を正しく利用できるように、プロンプトに説明を追加します。

1.  メインプロンプトの「利用可能なツールと使い方」セクションの後に、以下の説明を追記してください。

> **アクション間のデータ連携:**
> `actions`リスト内で、前のアクションの実行結果を後のアクションの入力として使用できます。
> 1.  まず、結果を使いたいアクションに `"action_id": "some_unique_id"` のようにIDを付与します。
> 2.  次に、後続のアクションの `parameters` の値に `"ref:some_unique_id"` と指定します。
>
> これにより、`some_unique_id` のアクションの実行結果全体が、パラメータの値として自動的に引き渡されます。

## 3. レビューの観点
実装完了後、私がレビューする際の主要な確認項目は以下の通りです。

1.  `_generate_hierarchical_plan` のプロンプトは、`active_plan` の有無に応じて動的に変化し、正しい指示を含んでいるか。
2.  `_dispatch_actions` メソッドが実装され、`turn_results` 辞書を使ってアクションの結果を追跡しているか。
3.  `_preprocess_action_args` ヘルパーメソッドが実装され、`ref:` 構文を正しく解決しているか。
4.  メインプロンプトに、データ連携機能 (`ref:`構文) の使い方がLLM向けに説明されているか。