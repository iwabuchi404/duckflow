# ドキュメント：v4.4 データ連携の安定化・実装指示書

## 1. 概要

### 1.1. 目的
LLMがアクションプランを立案する際に、アクション間のデータ連携（`ref:`構文）をより確実かつ正確に利用できるようにする。これにより、「ファイルは読めたのに、その結果を使って応答できない」といった問題を解決し、タスク全体の成功率を向上させる。

### 1.2. 根本原因の分析
前回のログ分析により、問題はツールのバグではなく、LLMの計画立案の不備にあることが判明しました。具体的には、LLMはデータ連携の必要性を理解しているものの、参照元となるアクションに `action_id` を設定し忘れるというミスを犯しています。

これは、現在のプロンプトに含まれる具体例が単純すぎて、`action_id` と `ref:` を組み合わせた一連の流れをLLMが十分に学習できていないことが原因です。

### 1.3. 解決策
プロンプトを修正し、データ連携を用いたより実践的な思考とアクションの具体例を追加します。これにより、LLMの理解を促し、より正確なプランを生成できるように誘導します。

### 1.4. 主な対象ファイル
- `companion/enhanced_core_v8.py`: メインプロンプトの具体例セクションを更新します。

---

## 2. 実装ステップ

### ステップ1: プロンプトへの「データ連携の具体例」の追加

**担当ファイル:** `companion/enhanced_core_v8.py`
**担当メソッド:** `_generate_hierarchical_plan`

**タスク:**
現在プロンプトに存在する「思考とアクションの具体例」セクションに、**「例3」**として、データ連携を実際に使用する、より複雑なシナリオの例を追加してください。

**プロンプトの末尾に追加するテキスト:**
```
### 例3：データ連携を含む複合要求
- **ユーザー要求:** 「game_doc.mdを読んで、その概要を教えて」
- **思考プロセス:**
    1.  **意図の分類:** (B) 指針・例示
    2.  **計画の立案:** これは2段階のタスクだ。まず `read_file_chunk` でファイルを読み、その結果を次の `user_response_tool` に渡して要約を生成させる必要がある。そのためには、最初のアクションに `action_id` を設定し、次のアクションで `ref:` を使って参照する必要がある。
- **生成されるべきアクション:**
    ```json
    {
        "reasoning": "ユーザーはファイル内容の要約を求めている。まずファイルを読み、その結果を次のアクションに渡して要約を生成する、2段階の計画を立てる。",
        "actions": [
            {
                "action_id": "read_game_doc",
                "operation": "structured_file_ops.read_file_chunk",
                "parameters": { "file_path": "game_doc.md", "size": 16384 },
                "reasoning": "まずファイルの全体像を把握するために、最大16KBを読み込む。"
            },
            {
                "operation": "user_response_tool.generate_response",
                "parameters": {
                    "action_results": "ref:read_game_doc",
                    "user_input": "game_doc.mdを読んで、その概要を教えて"
                },
                "reasoning": "前のアクションで読み込んだファイル内容(ref:read_game_doc)を基に、ユーザー向けの要約を生成する。"
            }
        ]
    }
    ```
```

**実装上の注意:**
- 上記のテキストブロックを、既存の「例2」のブロックの直後に追加してください。
- JSON内のエスケープ文字（`"`）が正しくPythonの文字列として表現されるように注意してください。

## 3. レビューの観点

実装完了後、司令塔として私がレビューする際の主要な確認項目は以下の通りです。

1.  `_generate_hierarchical_plan` のプロンプトに、上記の「例3：データ連携を含む複合要求」が正しく追加されているか。
2.  この修正後、「ファイルを読んで要約して」のようなデータ連携が必要なタスクを指示した際に、LLMが生成する `actions` リスト内で、一つ目のアクションに `action_id` が設定され、二つ目のアクションの `parameters` で `ref:` を使った参照が正しく行われるか。
