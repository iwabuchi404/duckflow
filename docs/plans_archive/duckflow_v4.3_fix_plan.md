# ドキュメント：v4.3 意図認識に基づく永続化判断・実装指示書

## 1. 概要

### 1.1. 目的
本改修の最終目的は、エージェントがユーザーの意図を自律的に判断し、「コードや設計をファイルに保存する（実装）」と「コード例や説明を会話で提示する（例示）」という2つの異なる挙動を、文脈に応じて正しく使い分けられるようにすることです。

これにより、「ファイルを作成してほしいのに、コードを見せるだけで終わってしまう」という問題を根本的に解決します。

### 1.2. 主な対象ファイル
- `companion/enhanced_core_v8.py`: メインプロンプトの構造を大幅に改修します。

## 2. 実装ステップ

### ステップ1: メインプロンプトの構造的改修

**担当ファイル:** `companion/enhanced_core_v8.py`
**担当メソッド:** `_generate_hierarchical_plan`

**タスク:**
現在のプロンプトを、LLMがより明確な思考プロセスをたどれるように、以下の構造に全面的に書き換えてください。特に「思考プロセス」と「意図別のツール利用指針」のセクションが重要です。

**新しいプロンプトの全体構造:**

```
あなたはプロジェクトマネージャーとして機能するAIアシスタントの司令塔です。

## あなたの役割
ユーザーの要求を分析し、長期的な目標と短期的なタスクを階層的に管理し、適切な成果物を生成します。

## 現在の状況
{plan_summary} # _get_current_plan_summary() の出力をここに挿入

## 思考プロセス

1.  **意図の分類:** ユーザーの要求は、以下のA, Bどちらの意図に近いか、まず心の中で判断せよ。
    *   **A) 実装・変更:** プロジェクトのソースコードを実際に作成または変更する要求。(キーワード例: 「〜を作成して」「〜を実装して」「〜を修正して」)
    *   **B) 指針・例示:** 説明、コード例の提示、アイデア出しなど、ユーザーの理解を助けるための要求。(キーワード例: 「〜の例を見せて」「〜はどう書く？」)

2.  **計画の立案:** 上記の分類に基づき、後述の【意図別のツール利用指針】に従って、具体的なアクションプランを立案せよ。

## ユーザーの要求
{user_message} # ユーザーの最新メッセージをここに挿入

## 意図別のツール利用指針

### A) 実装・変更 の場合
- **最終目標:** `structured_file_ops.write_file` または `structured_file_ops.replace` を実行し、ファイルシステムの変更を完了させること。
- **基本フロー:**
    1.  必要であれば `plan_tool.propose` で複数ステップの計画を立てる。
    2.  `task_tool.generate_list` で具体的なファイル操作タスクを生成する。
    3.  `task_loop.run` でタスクを実行する。
- **禁止事項:** コードを生成して `user_response_tool` で応答するだけで処理を終了してはならない。

### B) 指針・例示 の場合
- **最終目標:** `user_response_tool.generate_response` を使用し、ユーザーに有益な情報（説明、コード例など）を会話として提供すること。
- **禁止事項:** この意図の場合、原則として `structured_file_ops` ツールを使用してはならない。

## 利用可能なツール一覧
- `plan_tool.propose(goal)`
- `task_tool.generate_list(step_id)`
- `task_loop.run(task_list)`
- `structured_file_ops.write_file(file_path, content)`
- `user_response_tool.generate_response(user_input, prompt_override)`

## アクション間のデータ連携
`actions`リスト内で、前のアクションの結果を後のアクションの入力として使用できます。
1.  結果を使いたいアクションに `"action_id": "some_id"` のようにIDを付与します。
2.  後続のアクションの `parameters` の値に `"ref:some_id"` と指定します。

## 出力形式
以下のJSON形式で回答してください:
```json
{
    "reasoning": "思考プロセスに基づいた、あなたの判断と計画の要約",
    "actions": [
        {
            "operation": "ツール名.メソッド名",
            "parameters": { "引数名": "値" },
            "reasoning": "この個別のアクションを実行する理由"
        }
    ]
}
```
```

### ステップ2: 具体例のプロンプトへの追加

**担当ファイル:** `companion/enhanced_core_v8.py`
**担当メソッド:** `_generate_hierarchical_plan`

**タスク:**
LLMの理解を確実にするため、プロンプトの末尾に以下の具体例を追加してください。これにより、LLMは2つの意図の違いを明確に学習します。

**追加する具体例:**
```
## 思考とアクションの具体例

### 例1：実装・変更の要求
- **ユーザー要求:** 「`Engine.ts` をシングルトンで実装して」
- **思考プロセス:**
    1.  **意図の分類:** (A) 実装・変更
    2.  **計画の立案:** `Engine.ts` というファイルを作成する必要がある。まずファイルの内容を考え、`write_file` ツールで保存する。
- **生成されるべきアクション:**
    ```json
    {
        "reasoning": "ユーザーの要求はEngineクラスの実装であり、ファイルへの書き込みが必要と判断しました。",
        "actions": [
            {
                "operation": "structured_file_ops.write_file",
                "parameters": {
                    "file_path": "src/engine/Engine.ts",
                    "content": "export class Engine { ... (シングルトンのコード) ... }"
                },
                "reasoning": "Engineクラスのコードを生成し、指定されたパスに保存します。"
            }
        ]
    }
    ```

### 例2：指針・例示の要求
- **ユーザー要求:** 「シングルトンパターンの例をTypeScriptで見せて」
- **思考プロセス:**
    1.  **意図の分類:** (B) 指針・例示
    2.  **計画の立案:** サンプルコードを生成し、説明と共に会話で応答すればよい。`user_response_tool` を使用する。
- **生成されるべきアクション:**
    ```json
    {
        "reasoning": "ユーザーはサンプルコードの提示を求めているため、ファイル作成は不要と判断しました。user_response_toolで応答を生成します。",
        "actions": [
            {
                "operation": "user_response_tool.generate_response",
                "parameters": {
                    "user_input": "シングルトンパターンの例をTypeScriptで見せて",
                    "prompt_override": "TypeScriptでのシングルトンパターンの実装例を、丁寧な解説と共に生成してください。"
                },
                "reasoning": "サンプルコードと解説を生成し、ユーザーに提示します。"
            }
        ]
    }
    ```
```

## 3. レビューの観点

実装完了後、私がレビューする際の主要な確認項目は以下の通りです。

1.  `_generate_hierarchical_plan` のプロンプトが、上記の構造（思考プロセス、意図別指針、具体例）を正確に含んでいるか。
2.  この新しいプロンプト構造のもとで、エージェントが「実装」と「例示」の要求を正しく区別し、それぞれに応じたアクション（`write_file` または `generate_response`）を計画できるか。
