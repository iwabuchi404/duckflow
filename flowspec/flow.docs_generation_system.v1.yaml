id: flow.docs_generation_system.v1
title: フロー説明用ドキュメント生成システム
version: 1
status: approved   # draft|approved|deprecated
owner: team/companion
scope: FlowSpec から Markdown ドキュメントとシーケンス図を自動生成するシステム
summary: FlowSpec を基に docs/flows 配下に人間可読なフロー文書を生成する
rationale: FlowSpec を単一真実源として扱い、ドキュメントの整合性とレビュー効率を向上させる
human_notes: ''  # 任意の補足説明

routing: []  # ユーザー対話からのルーティングは不要

steps:
  - id: s1
    name: load_flowspecs
    actor: compile_flows
    inputs: [flowspec_dir]
    outputs: [flow_files]
    hint: FlowSpec ディレクトリから *.yaml を取得
  - id: s2
    name: load_templates
    actor: compile_flows
    inputs: [template_dir]
    outputs: [flow_card_template, sequence_template]
    hint: Jinja2 テンプレートをロード
  - id: s3
    name: render_sequence_diagram
    actor: compile_flows
    inputs: [flow_data, sequence_template]
    outputs: [mermaid_diagram]
    hint: Mermaid シーケンス図を生成
  - id: s4
    name: render_flow_card
    actor: compile_flows
    inputs: [flow_data, flow_card_template, mermaid_diagram]
    outputs: [flow_md_content]
    hint: FlowCard（概要・ステップ・分岐・観測情報）を Markdown にレンダリング
  - id: s5
    name: write_output
    actor: compile_flows
    inputs: [output_path, flow_md_content]
    outputs: [output_file]
    hint: docs/flows/<flow_id>.md に書き出し

approvals:
  high: manual_required
  medium: policy_default
  low: policy_default

error_handling:
  - when: no_flowspecs_found
    action: abort
    redirect: N/A
  - when: template_missing
    action: abort
    redirect: N/A

observability:
  events: [compile_started, flow_processed, compile_completed]
  log_keys: [flow_id, file_name]
  artifacts: [docs/flows/<flow_id>.md]
