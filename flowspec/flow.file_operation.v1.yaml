id: flow.file_operation.v1
title: ファイル操作（プラン→承認→実行）
version: 1
status: approved
owner: team/companion
scope: 作成/修正要求に対する安全なファイル変更の適用

summary: PlanTool を単一真実源として、プラン提示→明細設定→承認→実行を行う
rationale: 監査性と安全性（承認/再承認/差分検証）を担保するため
human_notes: >-
  上位フロー（flow.duckflow_chat_flow.v1）から creation/modification の要求で呼ばれます。
  SimpleFileOps の承認付き書き込み経路で実行し、成果を logs/plans/<plan_id> に保存します。

routing:
  - id: r1
    if: task_profile in [creation, modification] and confidence >= 0.7
    route: plan_execute
    reason: 作成/修正要求の標準経路

steps:
  - id: s1
    name: plan_tool.propose
    actor: plan_tool
    outputs: [plan_id]
    hint: プラン本文を保存し ID を発行
  - id: s2
    name: plan_tool.set_action_specs
    actor: plan_tool
    outputs: [validation_report]
  - id: s3
    name: approval_ui.request_and_approve
    actor: approval_ui
    outputs: [approved]
  - id: s4
    name: plan_tool.execute
    actor: plan_tool
    outputs: [result]
    hint: SimpleFileOps.apply_with_approval_write により適用
  - id: s5
    name: post_report
    actor: system
    outputs: [artifacts, metrics]

approvals:
  high: manual_required
  medium: policy_default
  low: policy_default

error_handling:
  - when: preflight_changed
    redirect: s2
  - when: not_approved
    action: block_and_hint

observability:
  events: [plan_proposed, specs_set, approval_requested, approved, executed, completed]
  log_keys: [flow_id, step_id, plan_id, correlation_id]
  artifacts: [logs/plans/<plan_id>/plan.json]

