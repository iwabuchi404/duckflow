id: flow.chat_plan_execute.v1
title: チャット→プラン→承認→実行
version: 1
status: approved   # draft|approved|deprecated
owner: team/companion
scope: 対話からのファイル変更を伴う要求

summary: 対話から安全にファイル変更を実行する標準フロー
rationale: 作成/修正要求を承認制で実行し、監査可能性を確保
human_notes: ''  # 任意の短文。空なら定型文

routing:
  - id: r1
    if: task_profile in [creation, modification] and confidence >= 0.7
    route: plan_execute
    reason: 十分な確信度の作成/修正要求
  - id: r2
    if: task_profile == guidance
    route: direct_response
  - id: r3
    if: else
    route: clarification

steps:
  - id: s1
    name: intent_system.analyze
    actor: intent_system
    inputs: [user_message]
    outputs: [task_profile, confidence]
    hint: 入力を分類し、確信度を算出
  - id: s2
    name: router.route
    actor: router
    inputs: [task_profile, confidence]
    outputs: [route_type]
  - id: s3
    name: plan_tool.propose
    actor: plan_tool
    outputs: [plan_id]
    hint: プラン本文を保存しID発行
  - id: s4
    name: plan_tool.set_action_specs
    actor: plan_tool
    outputs: [validation_report]
  - id: s5
    name: approval_ui.request_and_approve
    actor: approval_ui
    outputs: [approved]
  - id: s6
    name: plan_tool.execute
    actor: executor
    outputs: [result]
  - id: s7
    name: post_report
    actor: system
    outputs: [artifacts, metrics]

approvals:
  high: manual_required
  medium: policy_default
  low: policy_default

error_handling:
  - when: preflight_changed
    redirect: s4
  - when: not_approved
    action: block_and_hint

observability:
  events: [plan_proposed, specs_set, approval_requested, approved, executed, completed]
  log_keys: [flow_id, step_id, plan_id, correlation_id]
  artifacts: [logs/plans/<plan_id>/plan.json]
