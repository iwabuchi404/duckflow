---
description: このプロンプトは、Duckflowシステムの設計思想と重要な仕組みを理解するためのものです。AIがDuckflowに関連する設計や開発作業を行う際に、基本的な哲学やアーキテクチャの原則を把握するために使用してください。
alwaysApply: false
---
# Duckflow設計思想・重要仕組み把握プロンプト

## 基本設計思想

### 1. 哲学
Duckflowは、効率や自動化を追求する従来のAI開発ツールとは根本的に異なる価値を提供します。個人開発者が直面する最大の課題は技術的な問題ではなく、**継続する意欲の維持**です。

- **v3設計思想**: 「相棒は演じるものではなく、なるもの」- 速く正確にではなく、「一緒に続ける」を選ぶ
- **v4設計思想**: 統一ツールコールモデル - 固定的なコマンドを排除し、AIの自律的判断を促進

### 2. アーキテクチャ原則
- **既存システムの活用**: 完全な作り直しではなく、優れたコンポーネントを継承・拡張
- **責任分離**: 各コンポーネントの役割を明確に分離し、見通しが良く、拡張性の高いコードベースを構築
- **透明性と誠実さ**: AIの思考過程を可能な限り開示し、不確実性を隠さない

## 重要な仕組み

### 1. 三層プロンプトシステム
Duckflowでは、プロンプトを3つの層に分けて管理する仕組みを採用しています。これにより、トークン制限を効率的に管理し、状況に応じて必要な情報だけを含めることができます。

- **Base層**: システムの基本設定、制約、安全ルール（常に含まれる）
- **Main層**: 会話履歴、短期記憶、現在の状況（標準版で含まれる）
- **Specialized層**: 専門知識、詳細な手順書、長期記憶（完全版で含まれる）

**なぜ3層に分けるのか**:
- トークン制限を効率的に管理するため
- 状況に応じて必要な情報だけを含めるため
- 軽量版（Base+Specialized）、標準版（Base+Main）、完全版（Base+Main+Specialized）を使い分けるため

### 2. 階層的プランニングモデル
複雑なユーザー要求に対応するため、タスクを階層的に管理する仕組みです。鳥の社会の「階層序列」をメタファーとした、タスク管理システムです。

- **Plan**: ユーザーの長期的な目標を達成するための抽象的な計画
- **Step**: Planを構成する、より大きな単位のステップ（複数のTaskで構成）
- **Task**: 単一のツール実行を表すタスク（具体的な操作）

**基本的な考え方**:
- 複雑なタスクを親タスクとサブタスクに分解
- 親タスク（つつきの順位が高い）が完了すると、子タスク（つつかれる鳥）を実行
- 階層構造でタスクの実行順序を管理

### 3. 統一ツールコールモデル（v4）
v4アーキテクチャの核心は、**統一ツールコールモデル**にあります。これは、AI（メインLLM）の思考結果を、常に**「次に実行すべきツール操作のリスト」**という単一の形式で出力させる設計思想です。

- **ActionList**: メインLLMが次に実行すべき一連のActionを生成する
- **脱コマンド**: `propose_plan`や`execute_step`のような事前定義されたコマンドは存在しない
- **ツール呼び出し**: 全てのAIの行動は、`plan_tool.propose(...)`や`file_ops.write(...)`といった、特定のツールへの具体的な呼び出し指示(`Action`)として表現される

**このモデルの利点**:
- AIは固定観念に縛られず、利用可能なツールセットの中から最適な組み合わせを自律的に選択できる
- システムの柔軟性が向上し、複雑な要求にも対応可能

### 4. 承認システム
ファイル操作の安全性を確保するため、操作前の承認プロセスを実装しています。

- **安全性**: ファイル操作前の承認プロセスにより、意図しない変更を防止
- **リスク評価**: 操作の危険度に応じた承認レベルを設定（低リスクは自動承認、高リスクは手動承認必須）
- **監査**: すべての変更操作を記録し、後から追跡可能

**承認プロセスの流れ**:
1. ユーザーがファイル操作を要求
2. システムが操作の内容とリスクを評価
3. リスクレベルに応じて承認プロセスを実行
4. 承認後に操作を実行
5. 操作結果を記録

### 5. Pecking Orderシステム
Pecking Orderシステムは、階層的タスク管理を実現するための仕組みです。

- **階層的タスク管理**: 親タスクとサブタスクの木構造でタスクを管理
- **TaskNode**: タスクの階層関係と実行順序を管理するノード
- **TaskHierarchy**: タスク階層全体の管理と、依存関係の解決

**動作原理**:
- 複雑なタスクを論理的に分解し、実行可能なサブタスクに分割
- 依存関係を考慮して、適切な実行順序を決定
- 各タスクの完了状況を追跡し、全体の進捗を管理

## 技術スタック

### 基盤技術
- **言語**: Python 3.10+
- **LLM**: OpenAI/Anthropic API（大規模言語モデル）
- **UI**: Rich（ターミナルベースのリッチUI）
- **データ管理**: Pydantic（データ検証）、SQLite（データベース）

### 既存資産活用方針
- **`codecrafter/`**: 過去の実装、削除予定、参考資料として活用
- **`companion/`**: 現在の実装、継続的に開発・拡張

## 使用方法

このプロンプトは、Duckflowシステムの設計や開発を行う際に、基本的な設計思想と重要な仕組みを理解するために使用します。各セクションを順番に読み、理解を深めてから設計作業を開始してください。

特に重要なのは、Duckflowが「効率性より継続性を重視」し、「AIと人間の協調的な関係」を目指しているという根本的な哲学を理解することです。この哲学に基づいて、各技術的な仕組みが設計されていることを理解してください。