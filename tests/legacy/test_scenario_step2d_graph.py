#!/usr/bin/env python3
"""
test_step2d_graph.pyãƒ•ã‚¡ã‚¤ãƒ«æ¢ç´¢ãƒ»åˆ†æã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ

å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ªã€Œtest_step2d_graph.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦å‡¦ç†å†…å®¹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€
ã‚’5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã§å®Ÿè¡Œã—ã€å‹•ä½œã‚’ç¢ºèªã™ã‚‹
"""

import sys
import os
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

try:
    from codecrafter.main_v2 import DuckflowAgentV2
    from codecrafter.orchestration.five_node_orchestrator import FiveNodeOrchestrator
    import uuid
except ImportError as e:
    print(f"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    print("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„")
    sys.exit(1)


def test_step2d_graph_scenario():
    """test_step2d_graph.pyãƒ•ã‚¡ã‚¤ãƒ«æ¢ç´¢ãƒ»åˆ†æã‚·ãƒŠãƒªã‚ª"""
    print("=== test_step2d_graph.py æ¢ç´¢ãƒ»åˆ†æã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ ===")
    
    try:
        # DuckflowAgentV2åˆæœŸåŒ–
        agent = DuckflowAgentV2()
        print("âœ… DuckflowAgentV2åˆæœŸåŒ–æˆåŠŸ")
        
        # å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        user_message = "test_step2d_graph.pyãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦å‡¦ç†å†…å®¹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„"
        print(f"\nğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {user_message}")
        
        print("\n" + "="*60)
        print("ğŸš€ 5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œé–‹å§‹")
        print("="*60)
        
        # å¯¾è©±å®Ÿè¡Œ
        agent._handle_orchestrated_conversation(user_message)
        
        print("\n" + "="*60)
        print("ğŸ“Š å®Ÿè¡Œçµæœåˆ†æ")
        print("="*60)
        
        # çµæœç¢ºèª
        if agent.state.conversation_history:
            print(f"âœ… å¯¾è©±å±¥æ­´æ•°: {len(agent.state.conversation_history)}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
            
            # å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°ã‚’è¡¨ç¤º
            for i, msg in enumerate(agent.state.conversation_history):
                print(f"\n{i+1}. {msg.role.upper()}: {len(msg.content)}æ–‡å­—")
                if msg.role == 'user':
                    print(f"   å†…å®¹: {msg.content}")
                elif msg.role == 'assistant':
                    # ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­”ã®åˆ†æ
                    content = msg.content
                    
                    # å¿œç­”ã®ç‰¹å¾´ã‚’åˆ†æ
                    analysis = {
                        "ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹": "test_step2d_graph" in content.lower(),
                        "å‡¦ç†å†…å®¹èª¬æ˜": any(keyword in content for keyword in ["def ", "class ", "import ", "é–¢æ•°", "ã‚¯ãƒ©ã‚¹"]),
                        "ã‚³ãƒ¼ãƒ‰å†…å®¹": "```" in content,
                        "æ§‹é€ åŒ–ãƒ¬ãƒãƒ¼ãƒˆ": "##" in content and "###" in content,
                        "è©³ç´°åˆ†æ": len(content) > 2000,
                        "TaskProfileä½¿ç”¨": "Generated by Duckflow" in content
                    }
                    
                    print(f"   ğŸ“‹ å¿œç­”åˆ†æ:")
                    for feature, detected in analysis.items():
                        status = "âœ…" if detected else "âŒ"
                        print(f"      {status} {feature}: {detected}")
                    
                    # å¿œç­”å†…å®¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    print(f"\n   ğŸ“„ å¿œç­”ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:")
                    print("   " + "-" * 50)
                    preview = content[:500].replace('\n', '\n   ')
                    print(f"   {preview}")
                    if len(content) > 500:
                        print(f"   ... [æ®‹ã‚Š{len(content) - 500}æ–‡å­—]")
                    print("   " + "-" * 50)
                    
                    # æˆåŠŸåˆ¤å®š
                    success_criteria = [
                        analysis["ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹"],
                        analysis["å‡¦ç†å†…å®¹èª¬æ˜"],
                        analysis["æ§‹é€ åŒ–ãƒ¬ãƒãƒ¼ãƒˆ"],
                        len(content) > 1000
                    ]
                    
                    success_rate = sum(success_criteria) / len(success_criteria)
                    
                    if success_rate >= 0.75:
                        print(f"\n   ğŸ‰ ã‚·ãƒŠãƒªã‚ªæˆåŠŸç‡: {success_rate:.1%} - å„ªç§€")
                        return True
                    elif success_rate >= 0.5:
                        print(f"\n   âš ï¸ ã‚·ãƒŠãƒªã‚ªæˆåŠŸç‡: {success_rate:.1%} - éƒ¨åˆ†çš„æˆåŠŸ")
                        return True
                    else:
                        print(f"\n   âŒ ã‚·ãƒŠãƒªã‚ªæˆåŠŸç‡: {success_rate:.1%} - æ”¹å–„ãŒå¿…è¦")
                        return False
        else:
            print("âŒ å¯¾è©±å±¥æ­´ãŒç©ºã§ã™")
            return False
        
        return True
        
    except Exception as e:
        print(f"âŒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
        return False


def analyze_orchestration_flow():
    """ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼ã®åˆ†æ"""
    print("\n" + "="*60)
    print("ğŸ” 5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼åˆ†æ")
    print("="*60)
    
    expected_flow = [
        "1ï¸âƒ£ [The Architect] ç†è§£ãƒ»è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚º",
        "   - ãƒ•ã‚¡ã‚¤ãƒ«åæŠ½å‡º: test_step2d_graph.py",
        "   - TaskProfileåˆ†é¡: file_analysis",
        "   - needs_file_read: True",
        "",
        "2ï¸âƒ£ [The Librarian] æƒ…å ±åé›†ãƒ•ã‚§ãƒ¼ã‚º",
        "   - Duck Scanå®Ÿè¡Œ: test_step2d_graphæ¤œç´¢",
        "   - ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š: å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å–å¾—",
        "   - FileContentå¤‰æ›: åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ",
        "",
        "3ï¸âƒ£ [Quality Gate & Controller] è©•ä¾¡ãƒ»ç¶™ç¶šãƒ•ã‚§ãƒ¼ã‚º",
        "   - åé›†æƒ…å ±ã®å“è³ªè©•ä¾¡",
        "   - æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š: response_generation",
        "",
        "4ï¸âƒ£ [The Scribe] å¿œç­”ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º",
        "   - TaskProfileãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨",
        "   - ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®è©³ç´°åˆ†æ",
        "   - æ§‹é€ åŒ–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
    ]
    
    print("æœŸå¾…ã•ã‚Œã‚‹ãƒ•ãƒ­ãƒ¼:")
    for step in expected_flow:
        print(step)
    
    print("\nâœ… ã“ã®ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿç¾ã•ã‚Œã¾ã™:")
    print("   - æ­£ç¢ºãªãƒ•ã‚¡ã‚¤ãƒ«ç‰¹å®šãƒ»å–å¾—")
    print("   - å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å†…å®¹åˆ†æ")
    print("   - æ§‹é€ åŒ–ã•ã‚ŒãŸè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ")
    print("   - æ±ºå®šè«–çš„ã§äºˆæ¸¬å¯èƒ½ãªå¿œç­”å“è³ª")


def main():
    """ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    print("ğŸ¦† Duckflow 5ãƒãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£")
    print("test_step2d_graph.py æ¢ç´¢ãƒ»åˆ†æã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ")
    print("="*60)
    
    # ãƒ•ãƒ­ãƒ¼åˆ†æã‚’å…ˆã«è¡¨ç¤º
    analyze_orchestration_flow()
    
    # å®Ÿéš›ã®ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    success = test_step2d_graph_scenario()
    
    print("\n" + "="*60)
    print("ğŸ æœ€çµ‚çµæœ")
    print("="*60)
    
    if success:
        print("ğŸ‰ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆæˆåŠŸï¼")
        print("âœ… 5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯æœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¦ã„ã¾ã™")
        print("âœ… test_step2d_graph.pyãƒ•ã‚¡ã‚¤ãƒ«ã®æ¢ç´¢ãƒ»åˆ†æãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ")
        print("âœ… æ§‹é€ åŒ–ã•ã‚ŒãŸè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ")
    else:
        print("âŒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå¤±æ•—")
        print("âš ï¸ å•é¡Œã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„")
    
    return success


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)