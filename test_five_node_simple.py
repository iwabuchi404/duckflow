#!/usr/bin/env python3
"""
5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ç°¡å˜ãƒ†ã‚¹ãƒˆ

åŸºæœ¬çš„ãªèª¿æŸ»ã‚¿ã‚¹ã‚¯ã§å¿œç­”ç”Ÿæˆãƒãƒ¼ãƒ‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ã‚’ç¢ºèª
"""

import sys
import os
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

try:
    from codecrafter.orchestration.five_node_orchestrator import FiveNodeOrchestrator
    from codecrafter.state.agent_state import AgentState
    from codecrafter.ui.rich_ui import rich_ui
    from codecrafter.base.config import config_manager
    import uuid
except ImportError as e:
    print(f"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
    print("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„")
    sys.exit(1)


def test_simple_investigation():
    """ç°¡å˜ãªèª¿æŸ»ã‚¿ã‚¹ã‚¯ã®ãƒ†ã‚¹ãƒˆ"""
    print("=== 5ãƒãƒ¼ãƒ‰èª¿æŸ»ã‚¿ã‚¹ã‚¯ãƒ†ã‚¹ãƒˆ ===")
    
    try:
        # AgentStateåˆæœŸåŒ–
        state = AgentState(
            session_id=str(uuid.uuid4()),
            debug_mode=True
        )
        
        # 5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–
        orchestrator = FiveNodeOrchestrator(state)
        print("âœ… 5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–æˆåŠŸ")
        
        # èª¿æŸ»ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ
        test_message = "design-doc.mdã®å†…å®¹ã«ã¤ã„ã¦æ•™ãˆã¦"
        print(f"ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {test_message}")
        
        # å¯¾è©±å®Ÿè¡Œ
        orchestrator.run_conversation(test_message)
        
        # çµæœç¢ºèª
        print(f"\n=== å®Ÿè¡Œçµæœ ===")
        print(f"å¯¾è©±å±¥æ­´æ•°: {len(state.conversation_history)}")
        
        # å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
        for i, msg in enumerate(state.conversation_history):
            print(f"{i+1}. {msg.role}: {len(msg.content)}æ–‡å­—")
            if msg.role == 'assistant':
                print(f"   å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: {msg.content[:200]}...")
                
                # å¿œç­”ç”Ÿæˆãƒãƒ¼ãƒ‰ãŒå‹•ä½œã—ãŸã‹ã‚’ç¢ºèª
                if "Generated by Duckflow" in msg.content:
                    print("âœ… å¿œç­”ç”Ÿæˆãƒãƒ¼ãƒ‰ãŒå‹•ä½œã—ã¾ã—ãŸ")
                    return True
                elif len(msg.content) > 500:
                    print("âœ… è©³ç´°ãªå¿œç­”ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ")
                    return True
                else:
                    print("âš ï¸ çŸ­ã„å¿œç­”ã§ã™ - å¿œç­”ç”Ÿæˆãƒãƒ¼ãƒ‰ãŒå‹•ä½œã—ã¦ã„ãªã„å¯èƒ½æ€§")
        
        return len(state.conversation_history) > 1
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
        return False


def main():
    """ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    print("5ãƒãƒ¼ãƒ‰èª¿æŸ»ã‚¿ã‚¹ã‚¯ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™\n")
    
    success = test_simple_investigation()
    
    if success:
        print("\nğŸ‰ ãƒ†ã‚¹ãƒˆæˆåŠŸï¼")
        print("5ãƒãƒ¼ãƒ‰ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯åŸºæœ¬çš„ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚")
    else:
        print("\nâŒ ãƒ†ã‚¹ãƒˆå¤±æ•—")
        print("å•é¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    
    return success


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)